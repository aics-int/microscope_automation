
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>microscope_automation.microscope_automation &#8212; Microscope Automation 0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for microscope_automation.microscope_automation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main script for Microscope automation</span>
<span class="sd">Created on Jun 9, 2016</span>

<span class="sd">@author: winfriedw</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># store all images as numpy arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># use sys library to abort script and for other system operations</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># use shutil for file manipulations</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># use logging, setup will happen in module error_handling</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">imsave</span>

<span class="kn">from</span> <span class="nn">microscope_automation</span> <span class="kn">import</span> <span class="n">preferences</span>
<span class="kn">from</span> <span class="nn">microscope_automation</span> <span class="kn">import</span> <span class="n">automation_messages_form_layout</span> <span class="k">as</span> <span class="n">message</span>
<span class="kn">from</span> <span class="nn">microscope_automation.hardware</span> <span class="kn">import</span> <span class="n">setup_microscope</span>
<span class="kn">from</span> <span class="nn">microscope_automation</span> <span class="kn">import</span> <span class="n">error_handling</span>
<span class="kn">from</span> <span class="nn">microscope_automation.samples.setup_samples</span> <span class="kn">import</span> <span class="n">setup_plate</span>
<span class="kn">from</span> <span class="nn">microscope_automation.get_path</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">set_up_subfolders</span><span class="p">,</span>
    <span class="n">get_daily_folder</span><span class="p">,</span>
    <span class="n">get_recovery_settings_path</span><span class="p">,</span>
    <span class="n">get_references_path</span><span class="p">,</span>
    <span class="n">get_images_path</span><span class="p">,</span>
    <span class="n">get_position_csv_path</span><span class="p">,</span>
    <span class="n">get_colony_dir_path</span><span class="p">,</span>
    <span class="n">get_colony_remote_dir_path</span><span class="p">,</span>
    <span class="n">get_experiment_path</span><span class="p">,</span>
    <span class="n">get_meta_data_path</span><span class="p">,</span>
    <span class="n">get_valid_path_from_prefs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">microscope_automation.samples</span> <span class="kn">import</span> <span class="n">samples</span>
<span class="kn">from</span> <span class="nn">microscope_automation.hardware</span> <span class="kn">import</span> <span class="n">hardware_components</span>
<span class="kn">from</span> <span class="nn">microscope_automation.meta_data_file</span> <span class="kn">import</span> <span class="n">MetaDataFile</span>
<span class="kn">from</span> <span class="nn">microscope_automation.automation_exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StopCollectingError</span><span class="p">,</span>
    <span class="n">HardwareError</span><span class="p">,</span>
    <span class="n">AutomationError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">microscope_automation.software_state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">microscope_automation.find_positions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_output_objects_from_parent_object</span><span class="p">,</span>
    <span class="n">convert_location_list</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">microscope_automation.zeiss.write_zen_tiles_experiment</span> <span class="kn">import</span> <span class="n">PositionWriter</span>
<span class="kn">from</span> <span class="nn">microscope_automation.image_AICS</span> <span class="kn">import</span> <span class="n">ImageAICS</span>
<span class="kn">from</span> <span class="nn">microscope_automation.samples.well_segmentation_refined</span> <span class="kn">import</span> <span class="n">WellSegmentation</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pyqtgraph</span>
<span class="kn">from</span> <span class="nn">pyqtgraph.Qt</span> <span class="kn">import</span> <span class="n">QtGui</span>
<span class="kn">from</span> <span class="nn">aicsimageio</span> <span class="kn">import</span> <span class="n">AICSImage</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span>

<span class="c1">################################################################################</span>
<span class="c1">#</span>
<span class="c1"># constants with valid preferences values</span>
<span class="c1">#</span>
<span class="c1">################################################################################</span>
<span class="n">VALID_FUNCTIONNAME</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;initialize_microscope&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set_objective_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set_up_objectives&quot;</span><span class="p">,</span>
    <span class="s2">&quot;update_plate_z_zero&quot;</span><span class="p">,</span>
    <span class="s2">&quot;calculate_plate_correction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;calculate_all_wells_correction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;setup_immersion_system&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scan_plate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;segment_wells&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scan_samples&quot;</span><span class="p">,</span>
    <span class="s2">&quot;run_macro&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">VALID_SETUPFOLDERS</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_COPYCOLONYFILES</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_ADDCOLONIES</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_FINDLOAD</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_USEREFERENCE</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_LASERSAFETY</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_KOEHLER</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_VERBOSE</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_USEAUTOFOCUS</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_MANUELREFOCUS</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_SNAPIMAGE</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_WAIT</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_LOAD</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_LOADBETWEENWELLS</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_ADDIMERSIONWATER</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_USEPUMP</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="n">VALID_TILE_OBJECT</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NoTiling&quot;</span><span class="p">,</span> <span class="s2">&quot;Fixed&quot;</span><span class="p">,</span> <span class="s2">&quot;ColonySize&quot;</span><span class="p">,</span> <span class="s2">&quot;Well&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic&quot;</span><span class="p">]</span>
<span class="n">VALID_FINDTYPE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="s2">&quot;copy_zero_position&quot;</span><span class="p">,</span>
    <span class="s2">&quot;copy_image_position&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Interactive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CenterMassCellProfiler&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TwofoldDistanceMap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;InteractiveDistanceMap&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">VALID_WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]</span>
<span class="n">VALID_BLOCKING</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>


<div class="viewcode-block" id="MicroscopeAutomation"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation">[docs]</a><span class="k">class</span> <span class="nc">MicroscopeAutomation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefs_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">Preferences</span><span class="p">(</span><span class="n">prefs_path</span><span class="p">)</span>
        <span class="n">recovery_file_path</span> <span class="o">=</span> <span class="n">get_recovery_settings_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>

        <span class="c1"># Create the recovery folder if it does not exist.</span>
        <span class="n">rec_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">recovery_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rec_folder_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">rec_folder_path</span><span class="p">)</span>
        <span class="c1"># Create and save the pickle file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">recovery_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">less_dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;LessDialog&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">less_dialog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">less_dialog</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">failed_wells</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MicroscopeAutomation.get_well_object"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.get_well_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_well_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">well</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return well object for given well.</span>

<span class="sd">        Input:</span>
<span class="sd">         plate_holder_object: object for plateholder that contains well</span>

<span class="sd">         plate_name: name for plate, typically barcode</span>

<span class="sd">         well: name of well in form &#39;A1&#39;</span>

<span class="sd">        Output:</span>
<span class="sd">         well_object: object for well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get dictionary of all plates associated with plate holder</span>
        <span class="n">plate_objects</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="c1"># get object for plate with name plateName, typically the barcode</span>
        <span class="n">plate_object</span> <span class="o">=</span> <span class="n">plate_objects</span><span class="p">[</span><span class="n">plate_name</span><span class="p">]</span>

        <span class="c1"># get object for well with name well</span>
        <span class="n">well_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">well_object</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.get_barcode_object"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.get_barcode_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_barcode_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">well_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Barcode object for given well.</span>

<span class="sd">        Input:</span>
<span class="sd">         well_object: object for well that contains barcode</span>

<span class="sd">         barcode: string of name for barcode</span>

<span class="sd">        Output:</span>
<span class="sd">         barcode_object: object for barcode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get dictionary of all samples associated with well</span>
        <span class="n">sample_objects</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
        <span class="n">barcode_object</span> <span class="o">=</span> <span class="n">sample_objects</span><span class="p">[</span><span class="n">barcode</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">barcode_object</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.read_barcode"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.read_barcode">[docs]</a>    <span class="k">def</span> <span class="nf">read_barcode</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">well</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">barcode_name</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move manually to barcode, read and decipher barcode.</span>

<span class="sd">        Input:</span>
<span class="sd">         prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         barcode: barcode for plate, often used as plate name</span>

<span class="sd">         well: well the barcode is associated with in format &#39;A1&#39;.</span>
<span class="sd">         If empty ask user to navigate to barcode.</span>

<span class="sd">        Output:</span>
<span class="sd">         barcode: id encoded in barcode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Start reading barcode (read_barcode)&quot;</span><span class="p">)</span>

        <span class="c1"># Move to well and get wellObject</span>
        <span class="c1"># If no well is given retrieve it from preferences file</span>
        <span class="c1"># and ask user to navigate to position.</span>
        <span class="c1"># If well is given, move automatically to well.</span>
        <span class="k">if</span> <span class="n">well</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">well</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellBarcode&quot;</span><span class="p">)</span>
            <span class="n">barcode_name</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NameBarcode&quot;</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span><span class="s2">&quot;Please focus on barcode in well &quot;</span> <span class="o">+</span> <span class="n">well</span><span class="p">)</span>
            <span class="n">well_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_well_object</span><span class="p">(</span><span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">well</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">well_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_well_object</span><span class="p">(</span><span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">well</span><span class="p">)</span>
            <span class="n">well_object</span><span class="o">.</span><span class="n">get_container</span><span class="p">()</span><span class="o">.</span><span class="n">move_to_well</span><span class="p">(</span><span class="n">well</span><span class="p">)</span>

        <span class="c1"># get barcode object</span>
        <span class="n">barcode_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_barcode_object</span><span class="p">(</span><span class="n">well_object</span><span class="p">,</span> <span class="n">barcode_name</span><span class="p">)</span>

        <span class="c1"># get name for microscope settings as defined within microscope software</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;ExperimentBarcode&quot;</span><span class="p">)</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;CameraBarcode&quot;</span><span class="p">)</span>

        <span class="c1"># Define and if necessary create folder for images</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">get_references_path</span><span class="p">(</span><span class="n">prefs</span><span class="p">)</span>

        <span class="c1"># acquire image</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">image_dir</span> <span class="o">+</span> <span class="n">barcode_name</span> <span class="o">+</span> <span class="s2">&quot;.czi&quot;</span>
        <span class="n">barcode</span> <span class="o">=</span> <span class="n">barcode_object</span><span class="o">.</span><span class="n">read_barcode</span><span class="p">(</span>
            <span class="n">experiment</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">barcode</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.calculate_all_wells_correction"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.calculate_all_wells_correction">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_all_wells_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">_experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate correction factor for well coordinate system for all wells.</span>

<span class="sd">        Input:</span>
<span class="sd">         prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object for plateholder that contains well</span>

<span class="sd">         _experiment: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># iterate through all plates on plate holder</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span> <span class="ow">in</span> <span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">wells</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_wells</span><span class="p">()</span>
            <span class="n">reference_well_1</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellCalibrateWell_1&quot;</span><span class="p">)</span>
            <span class="n">measured_diameter_1</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span>
                <span class="n">reference_well_1</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_measured_diameter</span><span class="p">()</span>

            <span class="n">reference_well_2</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellCalibrateWell_2&quot;</span><span class="p">)</span>
            <span class="n">measured_diameter_2</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span>
                <span class="n">reference_well_2</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_measured_diameter</span><span class="p">()</span>

            <span class="n">reference_well_3</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellCalibrateWell_3&quot;</span><span class="p">)</span>
            <span class="n">measured_diameter_3</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span>
                <span class="n">reference_well_3</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_measured_diameter</span><span class="p">()</span>

            <span class="n">measured_diameter</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">[</span><span class="n">measured_diameter_1</span><span class="p">,</span> <span class="n">measured_diameter_2</span><span class="p">,</span> <span class="n">measured_diameter_3</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># set measuredDiameter for all wells to measuredDiameter from reference well</span>
            <span class="c1"># update calibration correction for all wells</span>
            <span class="k">for</span> <span class="n">well_name</span><span class="p">,</span> <span class="n">well_object</span> <span class="ow">in</span> <span class="n">wells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">set_measured_diameter</span><span class="p">(</span><span class="n">measured_diameter</span><span class="p">)</span>
                <span class="n">x_correction</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">well_object</span><span class="o">.</span><span class="n">get_measured_diameter</span><span class="p">()</span>
                    <span class="o">/</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_assigned_diameter</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">y_correction</span> <span class="o">=</span> <span class="n">x_correction</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">set_correction</span><span class="p">(</span><span class="n">x_correction</span><span class="p">,</span> <span class="n">y_correction</span><span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.setup_immersion_system"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.setup_immersion_system">[docs]</a>    <span class="k">def</span> <span class="nf">setup_immersion_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">plate_holder_instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup system to deliver immersion water</span>

<span class="sd">        Input:</span>
<span class="sd">         prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_instance: instance for plateholder that contains immersion system</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: this function should be part of pump.initialize() in module hardware.py</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Set-up water immersion system (setup_immersion_system)&quot;</span><span class="p">)</span>

        <span class="c1"># get immersion delivery system object</span>
        <span class="n">immersion_delivery</span> <span class="o">=</span> <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">immersion_delivery_system</span>

        <span class="c1"># move objective under immersion water outlet and assign position</span>
        <span class="c1"># of outlet to immersion delivery object</span>
        <span class="n">microscope</span> <span class="o">=</span> <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span>
        <span class="n">focus_id</span> <span class="o">=</span> <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">get_focus_id</span><span class="p">()</span>
        <span class="n">focus_drive</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">_get_microscope_object</span><span class="p">(</span><span class="n">focus_id</span><span class="p">)</span>
        <span class="n">load_position</span> <span class="o">=</span> <span class="n">focus_drive</span><span class="o">.</span><span class="n">get_load_position</span><span class="p">()</span>

        <span class="c1"># get communication object</span>
        <span class="n">communication_object</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">_get_control_software</span><span class="p">()</span><span class="o">.</span><span class="n">connection</span>
        <span class="p">)</span>

        <span class="c1"># Make sure load position is defined for focus drive</span>
        <span class="k">if</span> <span class="n">load_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span><span class="s2">&quot;Move objective to load position.&quot;</span><span class="p">)</span>
            <span class="n">focus_drive</span><span class="o">.</span><span class="n">define_load_position</span><span class="p">(</span><span class="n">communication_object</span><span class="p">)</span>
            <span class="n">load_position</span> <span class="o">=</span> <span class="n">focus_drive</span><span class="o">.</span><span class="n">get_load_position</span><span class="p">()</span>

        <span class="n">x_pos</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;xImmersionSystem&quot;</span><span class="p">)</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;yImmersionSystem&quot;</span><span class="p">)</span>

        <span class="c1"># Execute experiment before moving stage to ensure that proper objective</span>
        <span class="c1"># (typically 10x) in in place to avoid collision.</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;ExperimentSetupImmersionSystem&quot;</span><span class="p">)</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;CameraSetupImmersionSystem&quot;</span><span class="p">)</span>

        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">execute_experiment</span><span class="p">(</span>
            <span class="n">experiment</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">move_to_abs_position</span><span class="p">(</span>
            <span class="n">x_pos</span><span class="p">,</span>
            <span class="n">y_pos</span><span class="p">,</span>
            <span class="n">load_position</span><span class="p">,</span>
            <span class="n">reference_object</span><span class="o">=</span><span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># take image of water outlet</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">live_mode_start</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span>
            <span class="s2">&quot;Move objective under water outlet.&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use flashlight from below stage to see outlet.&quot;</span>
        <span class="p">)</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">live_mode_stop</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>

        <span class="c1"># drop objective to load position and store position for water delivery</span>
        <span class="c1"># water is always delivered with objective in load position to avoid collision</span>
        <span class="n">focus_drive</span><span class="o">.</span><span class="n">goto_load</span><span class="p">(</span><span class="n">communication_object</span><span class="p">)</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">set_zero</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># move away from delivery system to avoid later collisions</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">move_to_safe</span><span class="p">()</span>
        <span class="n">magnification</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;MagnificationImmersionSystem&quot;</span><span class="p">)</span>
        <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">magnification</span> <span class="o">=</span> <span class="n">magnification</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.set_up_objectives"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.set_up_objectives">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_up_settings</span><span class="p">,</span> <span class="n">plate_holder_instance</span><span class="p">,</span> <span class="n">_experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve objectives mounted at microscope.</span>

<span class="sd">        Input:</span>
<span class="sd">         set_up_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_instance: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         _experiment: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">set_up_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Set-up objectives (set_up_objectives)&quot;</span><span class="p">)</span>

        <span class="c1"># move stage and focus drive to save position before switching objectives</span>
        <span class="n">x_pos</span> <span class="o">=</span> <span class="n">set_up_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;xSetUpObjectives&quot;</span><span class="p">)</span>
        <span class="n">y_pos</span> <span class="o">=</span> <span class="n">set_up_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;ySetUpObjectives&quot;</span><span class="p">)</span>
        <span class="n">z_pos</span> <span class="o">=</span> <span class="n">set_up_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;zSetUpObjectives&quot;</span><span class="p">)</span>

        <span class="c1"># retrieve information about mounted objectives</span>
        <span class="c1"># This part will detect all objectives defined in the touch pad software.</span>
        <span class="n">microscope_instance</span> <span class="o">=</span> <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span>
        <span class="n">objective_changer_instance</span> <span class="o">=</span> <span class="n">microscope_instance</span><span class="o">.</span><span class="n">_get_microscope_object</span><span class="p">(</span>
            <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">objective_changer_id</span>
        <span class="p">)</span>
        <span class="n">communication_object</span> <span class="o">=</span> <span class="n">microscope_instance</span><span class="o">.</span><span class="n">_get_control_software</span><span class="p">()</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">objectives_dict</span> <span class="o">=</span> <span class="n">objective_changer_instance</span><span class="o">.</span><span class="n">get_all_objectives</span><span class="p">(</span>
            <span class="n">communication_object</span>
        <span class="p">)</span>
        <span class="n">objective_information</span> <span class="o">=</span> <span class="n">objective_changer_instance</span><span class="o">.</span><span class="n">objective_information</span>

        <span class="c1"># step through all objectives and determine parfocality and parcentrizity</span>
        <span class="c1"># create ordered dictionary with immersions to ensure</span>
        <span class="c1"># that we start with air and end with oil objectives</span>
        <span class="n">magnifications_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">magnification</span>
                <span class="k">for</span> <span class="n">magnification</span><span class="p">,</span> <span class="n">objective</span> <span class="ow">in</span> <span class="n">objectives_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">objective</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span>
            <span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">immersions_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="s2">&quot;glycerol&quot;</span><span class="p">,</span> <span class="s2">&quot;oil&quot;</span><span class="p">]</span>

        <span class="c1"># the offset for each objective will be calculated relative to the highest</span>
        <span class="c1"># resolution air objective (water if air does not exist)</span>
        <span class="n">x_reference_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">y_reference_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">z_reference_position</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">immersion</span> <span class="ow">in</span> <span class="n">immersions_list</span><span class="p">:</span>
            <span class="n">immersion_objectives</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">objective_information</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;immersion&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">immersion</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">magnification</span> <span class="ow">in</span> <span class="n">magnifications_list</span><span class="p">:</span>
                <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">objective</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">],</span>
                        <span class="n">objective</span><span class="p">[</span><span class="s2">&quot;camera&quot;</span><span class="p">],</span>
                        <span class="n">objective</span><span class="p">[</span><span class="s2">&quot;autofocus&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">objective</span> <span class="ow">in</span> <span class="n">immersion_objectives</span>
                    <span class="k">if</span> <span class="n">objective</span><span class="p">[</span><span class="s2">&quot;magnification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">magnification</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">camera</span><span class="p">,</span> <span class="n">auto_focus</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">:</span>
                    <span class="c1"># store status of auto-focus and switch offs</span>
                    <span class="n">auto_focus_status</span> <span class="o">=</span> <span class="n">microscope_instance</span><span class="o">.</span><span class="n">set_microscope</span><span class="p">(</span>
                        <span class="n">settings_dict</span><span class="o">=</span><span class="p">{</span><span class="n">auto_focus</span><span class="p">:</span> <span class="p">{}}</span>
                    <span class="p">)</span>
                    <span class="n">microscope_instance</span><span class="o">.</span><span class="n">set_microscope</span><span class="p">(</span>
                        <span class="n">settings_dict</span><span class="o">=</span><span class="p">{</span><span class="n">auto_focus</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;use_auto_focus&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
                    <span class="p">)</span>

                    <span class="n">microscope_instance</span><span class="o">.</span><span class="n">live_mode</span><span class="p">(</span>
                        <span class="n">camera_id</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="c1"># make sure that correct objective is selected</span>
                    <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">move_to_abs_position</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_pos</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                    <span class="p">)</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Please move to and focus on reference position.&quot;</span><span class="p">,</span>
                        <span class="n">return_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">microscope_instance</span><span class="o">.</span><span class="n">live_mode</span><span class="p">(</span>
                        <span class="n">camera_id</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

                    <span class="n">abs_position</span> <span class="o">=</span> <span class="n">plate_holder_instance</span><span class="o">.</span><span class="n">get_abs_position</span><span class="p">()</span>
                    <span class="n">x_pos</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">z_pos</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">x_reference_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">x_reference_position</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">y_reference_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">y_reference_position</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">z_reference_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">z_reference_position</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">x_offset</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_reference_position</span>
                    <span class="n">y_offset</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_reference_position</span>
                    <span class="n">z_offset</span> <span class="o">=</span> <span class="n">abs_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_reference_position</span>

                    <span class="c1"># this will update objective_changer_instance.objective_information</span>
                    <span class="n">objective_information</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;x_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_offset</span>
                    <span class="n">objective_information</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;y_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_offset</span>
                    <span class="n">objective_information</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;z_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_offset</span>

                    <span class="nb">print</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;New offset values for objective </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;x_offset: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">y_offset: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">z_offset: </span><span class="si">{}</span><span class="s2">&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">z_offset</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">microscope_instance</span><span class="o">.</span><span class="n">set_microscope</span><span class="p">(</span>
                        <span class="n">settings_dict</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">auto_focus</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;use_auto_focus&quot;</span><span class="p">:</span> <span class="n">auto_focus_status</span><span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.set_objective_offset"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.set_objective_offset">[docs]</a>    <span class="k">def</span> <span class="nf">set_objective_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset_prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">_experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set parfocality and parcentricity for objectives used in experiments.</span>

<span class="sd">        Input:</span>
<span class="sd">         offset_prefs: dictionary with preferences based on preferences.yml</span>

<span class="sd">         plate_holder_object: object that contains all plates</span>
<span class="sd">         and all wells with sample information.</span>

<span class="sd">         _experiment: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">offset_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="n">microscope_object</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span>

        <span class="c1"># retrieve list with experiments used to find objective offset</span>
        <span class="c1"># and iterate through them</span>
        <span class="n">experiments_list</span> <span class="o">=</span> <span class="n">offset_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;ExperimentsList&quot;</span><span class="p">)</span>

        <span class="c1"># iterate through all plates on plate holder</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span> <span class="ow">in</span> <span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments_list</span><span class="p">:</span>
                <span class="n">microscope_object</span><span class="o">.</span><span class="n">create_experiment_path</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

                <span class="n">objective_changer_id</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_objective_changer_id</span><span class="p">()</span>
                <span class="n">objective_changer</span> <span class="o">=</span> <span class="n">microscope_object</span><span class="o">.</span><span class="n">_get_microscope_object</span><span class="p">(</span>
                    <span class="n">objective_changer_id</span>
                <span class="p">)</span>
                <span class="n">objective_changer</span><span class="o">.</span><span class="n">set_init_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

                <span class="n">microscope_object</span><span class="o">.</span><span class="n">initialize_hardware</span><span class="p">(</span>
                    <span class="n">initialize_components_ordered_dict</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">objective_changer_id</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;no_find_surface&quot;</span><span class="p">}</span>
                    <span class="p">},</span>
                    <span class="n">reference_object_id</span><span class="o">=</span><span class="n">plate_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="n">trials</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="MicroscopeAutomation.set_up_koehler"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.set_up_koehler">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_koehler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialize_prefs</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up Koehler illumination.</span>

<span class="sd">        Input:</span>
<span class="sd">         initialize_prefs: dictionary with preferences based on preferences.yml</span>

<span class="sd">         plate_object: object of class plate</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get settings from preferences.yml</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Camera&quot;</span><span class="p">)</span>
        <span class="n">zen_experiment</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>
        <span class="n">well_name</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Well&quot;</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Load&quot;</span><span class="p">)</span>
        <span class="n">use_reference</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;UseReference&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEREFERENCE</span>
        <span class="p">)</span>
        <span class="n">use_auto_focus</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;UseAutoFocus&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEAUTOFOCUS</span>
        <span class="p">)</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NumberTrials&quot;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">)</span>

        <span class="n">microscope_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span>
        <span class="n">well_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">well_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
            <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span>
            <span class="n">reference_object</span><span class="o">=</span><span class="n">well_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
            <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
            <span class="n">use_reference</span><span class="o">=</span><span class="n">use_reference</span><span class="p">,</span>
            <span class="n">use_auto_focus</span><span class="o">=</span><span class="n">use_auto_focus</span><span class="p">,</span>
            <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">well_object</span><span class="o">.</span><span class="n">move_to_zero</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AutomationError</span><span class="p">(</span>
                <span class="s2">&quot;Microscope not ready in set_up_koehler with experiment </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">zen_experiment</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">microscope_object</span><span class="o">.</span><span class="n">live_mode</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span><span class="s2">&quot;Set-up Koehler illumination.&quot;</span><span class="p">)</span>
        <span class="n">microscope_object</span><span class="o">.</span><span class="n">live_mode</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="MicroscopeAutomation.initialize_microscope"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.initialize_microscope">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_microscope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialize_prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">_experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update z positions for plate (upper side of coverslip)</span>
<span class="sd">        Set load and work positions for focus drive.</span>

<span class="sd">        Input:</span>
<span class="sd">         initialize_prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         _experiment: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;CopyColonyFile&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_COPYCOLONYFILES</span>
        <span class="p">):</span>
            <span class="c1"># copy colony file</span>
            <span class="n">colony_remote_dir</span> <span class="o">=</span> <span class="n">get_colony_remote_dir_path</span><span class="p">(</span><span class="n">initialize_prefs</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;AddColonies&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_ADDCOLONIES</span><span class="p">)</span>
                <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">):</span>
                <span class="c1"># Add colonies is in the list of experiment,</span>
                <span class="c1"># show the options for csv file</span>
                <span class="n">colony_remote_file</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">file_select_dialog</span><span class="p">(</span>
                    <span class="n">colony_remote_dir</span><span class="p">,</span> <span class="n">return_code</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="c1"># continue if user did not press cancel</span>
                <span class="k">if</span> <span class="n">colony_remote_file</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colony_remote_dir</span><span class="p">,</span> <span class="n">colony_remote_file</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">destination_path</span> <span class="o">=</span> <span class="n">get_colony_dir_path</span><span class="p">(</span><span class="n">initialize_prefs</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>

        <span class="c1"># initialize microscope hardware (e.g. auto-focus)</span>
        <span class="c1"># for each plate within plateholder</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NumberTrials&quot;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="n">microscope_object</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">plate</span> <span class="ow">in</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Hardware&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">):</span>

                <span class="n">initialization_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="n">plate</span><span class="o">.</span><span class="n">get_focus_id</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;set_load&quot;</span><span class="p">]),</span>
                        <span class="p">(</span><span class="n">plate</span><span class="o">.</span><span class="n">get_stage_id</span><span class="p">(),</span> <span class="p">[]),</span>
                        <span class="p">(</span><span class="n">plate</span><span class="o">.</span><span class="n">get_objective_changer_id</span><span class="p">(),</span> <span class="p">[]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">microscope_object</span><span class="o">.</span><span class="n">initialize_hardware</span><span class="p">(</span>
                    <span class="n">initialize_components_ordered_dict</span><span class="o">=</span><span class="n">initialization_dict</span><span class="p">,</span>
                    <span class="n">reference_object_id</span><span class="o">=</span><span class="n">plate</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span>
                <span class="c1"># Autosave</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

            <span class="c1"># set Koehler illumination</span>
            <span class="k">if</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Koehler&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_KOEHLER</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_up_koehler</span><span class="p">(</span><span class="n">initialize_prefs</span><span class="p">,</span> <span class="n">plate</span><span class="p">)</span>

        <span class="c1"># ask user to enable laser safety</span>
        <span class="k">if</span> <span class="n">initialize_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;LaserSafety&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_LASERSAFETY</span><span class="p">):</span>
            <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span>
                <span class="s2">&quot;Please enable laser safety.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Disable parfocality and parcentralicy</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Secure sample from sliding.&quot;</span>
            <span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.update_plate_z_zero"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.update_plate_z_zero">[docs]</a>    <span class="k">def</span> <span class="nf">update_plate_z_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_settings</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update z positions for plate (upper side of coverslip)</span>
<span class="sd">        Set load and work positions for focus drive.</span>

<span class="sd">        Input:</span>
<span class="sd">         image_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Start to update z zero settings for plates (update_plate_z_zero)&quot;</span><span class="p">)</span>

        <span class="n">trials</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NumberTrials&quot;</span><span class="p">)</span>
        <span class="c1"># iterate through all plates on plate holder</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span> <span class="ow">in</span> <span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># get preferences</span>
            <span class="n">zen_experiment</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>
            <span class="n">camera_id</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Camera&quot;</span><span class="p">)</span>
            <span class="n">well_name</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Well&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_WELLS</span><span class="p">)</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Load&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_LOAD</span><span class="p">)</span>
            <span class="n">use_reference</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                <span class="s2">&quot;UseReference&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEREFERENCE</span>
            <span class="p">)</span>
            <span class="n">use_auto_focus</span> <span class="o">=</span> <span class="n">image_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                <span class="s2">&quot;UseAutoFocus&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEAUTOFOCUS</span>
            <span class="p">)</span>
            <span class="c1"># find zero z-position for plate (upper side of cover slip</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">live_mode_start</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">zen_experiment</span><span class="p">)</span>
            <span class="n">well_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">well_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="o">=</span><span class="n">well_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
                <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
                <span class="n">use_reference</span><span class="o">=</span><span class="n">use_reference</span><span class="p">,</span>
                <span class="n">use_auto_focus</span><span class="o">=</span><span class="n">use_auto_focus</span><span class="p">,</span>
                <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">):</span>

                <span class="k">if</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">update_z_zero_pos</span><span class="p">:</span>
                    <span class="n">plate_object</span><span class="o">.</span><span class="n">move_to_xyz</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">plate_object</span><span class="o">.</span><span class="n">update_z_zero_pos</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">well_object</span><span class="o">.</span><span class="n">move_to_zero</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AutomationError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Microscope not ready in update_plate_z_zero&quot;</span>
                        <span class="s2">&quot; with experiment </span><span class="si">{}</span><span class="s2">&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zen_experiment</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># User has to set focus position for following experiments</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span>
                <span class="s2">&quot;Please set the focus for your acquisition&quot;</span><span class="p">,</span> <span class="n">return_code</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state_and_exit</span><span class="p">()</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">live_mode_stop</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">zen_experiment</span><span class="p">)</span>

            <span class="c1"># get actual z-position for plate and set as new z_zero position</span>
            <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">z_new</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_container</span><span class="p">()</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">update_zero</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_new</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># store position used for focusing,</span>
            <span class="c1"># will make later focusing with higher magnification easier</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">update_z_zero_pos</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

            <span class="k">for</span> <span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">microscope_components_ordered_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>  <span class="c1"># noqa</span>
            <span class="p">):</span>
                <span class="c1"># Passage the previous experiment&#39;s objects if being called</span>
                <span class="c1"># as a separate workflow experiment</span>
                <span class="n">workflow_list</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowList&quot;</span><span class="p">]</span>
                <span class="n">original_workflow</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;OriginalWorkflow&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">workflow_list</span><span class="p">:</span>
                    <span class="n">previous_experiment</span> <span class="o">=</span> <span class="n">original_workflow</span><span class="p">[</span>
                        <span class="n">workflow_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">previous_experiment</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">next_experiment_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">):</span>
                        <span class="n">next_exp_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">next_experiment_objects</span><span class="p">[</span>
                            <span class="n">previous_experiment</span>
                        <span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_next_experiment_object</span><span class="p">(</span>
                            <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">],</span> <span class="n">next_exp_objects</span>
                        <span class="p">)</span>
                        <span class="c1"># Autosave</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.calculate_plate_correction"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.calculate_plate_correction">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_plate_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">_experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate correction factor for plate coordinate system.</span>

<span class="sd">        Input:</span>
<span class="sd">         prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object for plate that contains well</span>

<span class="sd">         _experiment: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Start to acquire images for plate correction&quot;</span>
            <span class="s2">&quot; (calculate_plate_correction)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># iterate through all plates on plate holder</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span> <span class="ow">in</span> <span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Acquire images of edges of three reference wells</span>
            <span class="c1"># and use them to determine the well center</span>
            <span class="c1"># Get names of reference wells</span>
            <span class="n">well_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellCalibrateWell_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># get well objects</span>
            <span class="n">well_objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well</span><span class="p">)</span> <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">well_names</span><span class="p">]</span>

            <span class="c1"># get imaging parameters</span>
            <span class="n">zen_experiment</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>
            <span class="n">well_diameter</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellDiameterCalibrateWell&quot;</span><span class="p">)</span>
            <span class="n">camera_id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Camera&quot;</span><span class="p">)</span>

            <span class="c1"># Move objective to load position before moving to next calibration well?</span>
            <span class="n">load</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Load&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_LOAD</span><span class="p">)</span>
            <span class="n">trials</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NumberTrials&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="o">=</span><span class="n">plate_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
                <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
                <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">AutomationError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Microscope not ready in calculate_plate_correction&quot;</span>
                        <span class="s2">&quot; with experiment </span><span class="si">{}</span><span class="s2">&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zen_experiment</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">def</span> <span class="nf">find_well_center</span><span class="p">(</span><span class="n">well_object</span><span class="p">,</span> <span class="n">well_index</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">move_delta_xyz</span><span class="p">(</span>
                    <span class="n">well_diameter</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">live_mode_start</span><span class="p">(</span>
                    <span class="n">camera_id</span><span class="o">=</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span>
                <span class="p">)</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">operate_message</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Please focus with 10x on left edge of well </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;to find zero position for plate </span><span class="si">{}</span><span class="s2">&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">well_names</span><span class="p">[</span><span class="n">well_index</span><span class="p">],</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
                    <span class="n">return_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state_and_exit</span><span class="p">()</span>

                <span class="c1"># find center of well in absolute stage coordinates</span>
                <span class="k">return</span> <span class="n">well_objects</span><span class="p">[</span><span class="n">well_index</span><span class="p">]</span><span class="o">.</span><span class="n">find_well_center_fine</span><span class="p">(</span>
                    <span class="n">zen_experiment</span><span class="p">,</span> <span class="n">well_diameter</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                <span class="p">)</span>

            <span class="c1"># find center of wells</span>
            <span class="n">well_center_abs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># The stored z position for wells is not necessarily the actual one.</span>
            <span class="c1"># store the difference between the z-position on file</span>
            <span class="c1"># and the last measured z-position as delta_z</span>
            <span class="c1"># apply this delta to the next well to be closer at the actual position</span>
            <span class="n">delta_z</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">well_object</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">well_objects</span><span class="p">):</span>
                <span class="c1"># Make sure that microscope is ready and correct objective is used</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
                    <span class="n">experiment</span><span class="o">=</span><span class="n">zen_experiment</span><span class="p">,</span>
                    <span class="n">reference_object</span><span class="o">=</span><span class="n">well_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
                    <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
                    <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">move_to_zero</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">move_delta_xyz</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta_z</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">x_pos_abs</span><span class="p">,</span> <span class="n">y_pos_abs</span><span class="p">,</span> <span class="n">z_pos_abs</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_abs_position</span><span class="p">()</span>

                <span class="n">well_center_abs_i</span> <span class="o">=</span> <span class="n">find_well_center</span><span class="p">(</span><span class="n">well_object</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="c1"># difference between actual z position of well and position on file</span>
                <span class="n">delta_z</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_abs_zero</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">well_center_abs_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">well_center_abs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">well_center_abs_i</span><span class="p">)</span>

            <span class="c1"># Calculate values for transformation from plate holder coordinates</span>
            <span class="c1"># to plate coordinates, then get plate coordinates for well centers</span>
            <span class="c1"># from zero positions of wells in plate coordinate</span>
            <span class="n">plate_centers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">well_objects</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">get_zero</span><span class="p">()</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">well_objects</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="c1"># Subtract x and y values to get distance between wells</span>
            <span class="n">x_plate_distance</span> <span class="o">=</span> <span class="n">plate_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_plate_distance</span> <span class="o">=</span> <span class="n">plate_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># get plate holder coordinates based on measured well centers</span>
            <span class="n">plate_holder_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_container</span><span class="p">()</span>
            <span class="n">plate_holder_centers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span><span class="o">*</span><span class="n">centers</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">centers</span> <span class="ow">in</span> <span class="n">well_center_abs</span>
            <span class="p">]</span>

            <span class="n">x_plate_holder_distance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">plate_holder_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_holder_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">y_plate_holder_distance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">plate_holder_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_holder_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># calculate corrections</span>
            <span class="n">x_plate_holder_correction</span> <span class="o">=</span> <span class="n">x_plate_holder_distance</span> <span class="o">/</span> <span class="n">x_plate_distance</span>
            <span class="n">y_plate_holder_correction</span> <span class="o">=</span> <span class="n">y_plate_holder_distance</span> <span class="o">/</span> <span class="n">y_plate_distance</span>
            <span class="n">z_plate_holder_correction</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Describe not leveled plate as plane of form ax + bx + cx = d</span>
            <span class="c1"># Calculate 2 vectors from 3 points, and use cross product</span>
            <span class="c1"># to find normal vector for plane &lt;a, b, c&gt;</span>
            <span class="c1"># Dot normal vector and point to get offset (d)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">plate_holder_centers</span>
            <span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">plane</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>

            <span class="c1"># normalize normal vector to avoid large numbers</span>
            <span class="n">normFactor</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">plane</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">plane</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">plane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">plane</span> <span class="o">/</span> <span class="n">normFactor</span>
            <span class="c1"># the plane can be described in the form ax + by +cz = d</span>
            <span class="c1"># a,b,c are the components of the normal vector and determine the slope</span>
            <span class="n">z_correction_x_slope</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">z_correction_y_slope</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z_correction_z_slope</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># We will choose the offset d so that it equals 0 at the position</span>
            <span class="c1">#  where zZero was defined for the plate in update_plate_well_zZero</span>
            <span class="c1">#  xPosAbs = prefs.get_pref(&#39;xUpdatePlateWellZero&#39;)</span>
            <span class="c1">#  yPosAbs = prefs.get_pref(&#39;yUpdatePlateWellZero&#39;)</span>
            <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">z_pos</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x_pos_abs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pos_abs</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="n">z_correction_offset</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">z_correction_x_slope</span> <span class="o">*</span> <span class="n">x_pos</span> <span class="o">+</span> <span class="n">z_correction_y_slope</span> <span class="o">*</span> <span class="n">y_pos</span>
            <span class="p">)</span>

            <span class="n">plate_object</span><span class="o">.</span><span class="n">set_correction</span><span class="p">(</span>
                <span class="n">x_correction</span><span class="o">=</span><span class="n">x_plate_holder_correction</span><span class="p">,</span>
                <span class="n">y_correction</span><span class="o">=</span><span class="n">y_plate_holder_correction</span><span class="p">,</span>
                <span class="n">z_correction</span><span class="o">=</span><span class="n">z_plate_holder_correction</span><span class="p">,</span>
                <span class="n">z_correction_x_slope</span><span class="o">=</span><span class="n">z_correction_x_slope</span><span class="p">,</span>
                <span class="n">z_correction_y_slope</span><span class="o">=</span><span class="n">z_correction_y_slope</span><span class="p">,</span>
                <span class="n">z_correction_z_slope</span><span class="o">=</span><span class="n">z_correction_z_slope</span><span class="p">,</span>
                <span class="n">z_correction_offset</span><span class="o">=</span><span class="n">z_correction_offset</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># set zero position for plate</span>
            <span class="c1"># transform stage center coordinates into plate coordinates</span>
            <span class="n">center_plate</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span>
                <span class="o">*</span><span class="n">well_center_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="c1"># set zero position for plate</span>
            <span class="c1"># transform stage center coordinates into plate coordinates</span>
            <span class="n">center_plate</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_pos_from_abs_pos</span><span class="p">(</span>
                <span class="o">*</span><span class="n">well_center_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="c1"># get center of well in plate coordinates.</span>
            <span class="c1"># This is equivalent to the distance to the center of well A1 = plate zero</span>
            <span class="n">plate_distances</span> <span class="o">=</span> <span class="n">well_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_zero</span><span class="p">()</span>
            <span class="n">plate_original</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_zero</span><span class="p">()</span>

            <span class="c1"># Update zero position for plate</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">set_zero</span><span class="p">(</span>
                <span class="n">plate_original</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">center_plate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">plate_original</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">center_plate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plate_distances</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">plate_original</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">well_names</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Center of well </span><span class="si">{}</span><span class="s2"> in stage coordinates: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">well_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">well_objects</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_abs_zero</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Zero position of plate </span><span class="si">{}</span><span class="s2"> in stage coordinates: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">plate_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_abs_zero</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.scan_wells_zero"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.scan_wells_zero">[docs]</a>    <span class="k">def</span> <span class="nf">scan_wells_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan selected wells at center.</span>
<span class="sd">        This method is mainly used to test calibrations.</span>

<span class="sd">        Input:</span>
<span class="sd">         prefs: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         barcode: barcode for plate, often used as plate name</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set debugging level</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Start scanning well centers (scan_wells_zero)&quot;</span><span class="p">)</span>

        <span class="c1"># get names of wells to scan</span>
        <span class="n">wells_string</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WellsScanWellsZero&quot;</span><span class="p">)</span>
        <span class="n">wells</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wells_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>

        <span class="c1"># name for settings as defined within microscope software</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;ExperimentScanWellsZero&quot;</span><span class="p">)</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;CameraScanWellsZero&quot;</span><span class="p">)</span>

        <span class="c1"># Define and if necessary create folder for images</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">get_images_path</span><span class="p">(</span><span class="n">prefs</span><span class="p">)</span>

        <span class="c1"># iterate through all wells</span>
        <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">wells</span><span class="p">:</span>
            <span class="n">well_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_well_object</span><span class="p">(</span><span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">well</span><span class="p">)</span>
            <span class="n">well_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
                <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="o">=</span><span class="n">well_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
                <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">trials</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">move_to_zero</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">image_dir</span> <span class="o">+</span> <span class="n">well</span> <span class="o">+</span> <span class="s2">&quot;_zero.czi&quot;</span>
            <span class="n">well_object</span><span class="o">.</span><span class="n">execute_experiment</span><span class="p">(</span>
                <span class="n">experiment</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">image_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well: &quot;</span><span class="p">,</span> <span class="n">well_object</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot; at position (x,y,z): &quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>

    <span class="c1">################################################################################</span>

    <span class="c1">################################################################################</span>
    <span class="c1">#</span>
    <span class="c1"># Scan colonies and cells</span>
    <span class="c1">#</span>
    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.scan_single_ROI"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.scan_single_ROI">[docs]</a>    <span class="k">def</span> <span class="nf">scan_single_ROI</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">experiment_dict</span><span class="p">,</span>
        <span class="n">sample_object</span><span class="p">,</span>
        <span class="n">reference_object</span><span class="p">,</span>
        <span class="n">image_path</span><span class="p">,</span>
        <span class="n">meta_dict</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">number_selected_postions</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acquire tiled image as defined in pos_list</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         experiment_dict: The dictionary with full information about the experiment</span>

<span class="sd">         sample_object: object of a sample type (e.g. cell, colony) to be imaged</span>

<span class="sd">         reference_object: object used to set parfocality and parcentricity,</span>
<span class="sd">         typically a well in plate</span>

<span class="sd">         image_path: string for filename with path to save image in original format</span>
<span class="sd">         or tuple with string to directory and list with template for file name.</span>
<span class="sd">         Default=None: no saving</span>

<span class="sd">         meta_dict: directory with additional meta data, e.g. {&#39;aics_well&#39;:, &#39;A1&#39;}</span>

<span class="sd">         verbose: if True print debug information (Default = True)</span>

<span class="sd">         number_selected_postions: number of positions collected so far</span>

<span class="sd">         repetition: counter for time lapse experiments</span>

<span class="sd">        Output:</span>
<span class="sd">         return_dict: dictionary of form {&#39;Image&#39;: [images], &#39;Continue&#39;: True/False}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Start scanning &quot;</span><span class="p">,</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s2">&quot; (scan_single_ROI)&quot;</span><span class="p">)</span>

        <span class="c1"># name for settings as defined within microscope software</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Camera&quot;</span><span class="p">)</span>

        <span class="n">trials</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NumberTrials&quot;</span><span class="p">)</span>
        <span class="n">use_auto_focus</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;UseAutoFocus&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEAUTOFOCUS</span>
        <span class="p">)</span>
        <span class="n">use_reference</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;UseReference&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEREFERENCE</span>
        <span class="p">)</span>

        <span class="c1"># Allow user to manually adjust focus position selected by auto focus</span>
        <span class="n">manual_refocus</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;ManualRefocus&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_MANUELREFOCUS</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">manual_refocus</span><span class="p">:</span>
            <span class="n">manual_refocus_after_repetitions</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                <span class="s2">&quot;ManualRefocusAfterRepetitions&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">manual_refocus_after_repetitions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">repetition</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">manual_refocus</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">repetition</span> <span class="o">%</span> <span class="n">manual_refocus_after_repetitions</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">manual_refocus</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image Object &quot;</span><span class="p">,</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Image&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Continue&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="c1"># check if microscope is ready for imaging</span>
        <span class="c1"># and tries to execute missing initializations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">microscope_is_ready</span><span class="p">(</span>
            <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
            <span class="n">reference_object</span><span class="o">=</span><span class="n">sample_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
            <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_reference</span><span class="o">=</span><span class="n">use_reference</span><span class="p">,</span>
            <span class="n">use_auto_focus</span><span class="o">=</span><span class="n">use_auto_focus</span><span class="p">,</span>
            <span class="n">make_ready</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">HardwareError</span><span class="p">(</span><span class="s2">&quot;Microscope not ready for imaging&quot;</span><span class="p">)</span>

        <span class="n">sample_object</span><span class="o">.</span><span class="n">move_to_zero</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># manual focus adjustment. New value is stored for future use</span>
        <span class="k">if</span> <span class="n">manual_refocus</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">============================== Before re-focus ========================================&quot;</span>  <span class="c1"># noqa</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Image object &quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="s2">&quot;Colony position before re-adjustment:&quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_zero</span><span class="p">(),</span>
                    <span class="s2">&quot;Stage position:&quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_abs_position</span><span class="p">(),</span>
                <span class="p">)</span>

            <span class="c1"># start live mode again because redefinition of auto-focus might stop it</span>
            <span class="n">sample_object</span><span class="o">.</span><span class="n">live_mode_start</span><span class="p">(</span><span class="n">camera_id</span><span class="o">=</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">)</span>
            <span class="n">select_result</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">select_message</span><span class="p">(</span>
                <span class="s2">&quot;Focus on center of &quot;</span>
                <span class="o">+</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Check box below if you want to&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; include position in further experiments.&quot;</span><span class="p">,</span>
                <span class="n">count</span><span class="o">=</span><span class="n">number_selected_postions</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sample_object</span><span class="o">.</span><span class="n">live_mode_stop</span><span class="p">(</span><span class="n">camera_id</span><span class="o">=</span><span class="n">camera_id</span><span class="p">)</span>

            <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;Continue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_result</span><span class="p">[</span><span class="s2">&quot;Continue&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">select_result</span><span class="p">[</span><span class="s2">&quot;Include&quot;</span><span class="p">]:</span>
                <span class="c1"># set center of sample object to new position</span>
                <span class="n">sample_object</span><span class="o">.</span><span class="n">set_zero</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">sample_object</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># label object to not be included in future imaging</span>
                <span class="n">sample_object</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">============================== After re-focus ========================================&quot;</span>  <span class="c1"># noqa</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Image colony &quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="s2">&quot;Colony position after re-adjustment:&quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_zero</span><span class="p">(),</span>
                    <span class="s2">&quot;Stage position:&quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_abs_position</span><span class="p">(),</span>
                    <span class="s2">&quot;Included in future imaging: &quot;</span><span class="p">,</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_image</span><span class="p">(),</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;SnapImage&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_SNAPIMAGE</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FindType&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_FINDTYPE</span><span class="p">)</span>
                    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FindType&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_FINDTYPE</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="s2">&quot;None&quot;</span>
                <span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FindType&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_FINDTYPE</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="s2">&quot;Copy&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span>
        <span class="p">):</span>

            <span class="n">tile_object</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                <span class="s2">&quot;Tile&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_TILE_OBJECT</span>
            <span class="p">)</span>
            <span class="n">pos_list</span> <span class="o">=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_tile_positions_list</span><span class="p">(</span>
                <span class="n">imaging_settings</span><span class="p">,</span> <span class="n">tile_object</span><span class="o">=</span><span class="n">tile_object</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">acquire_images</span><span class="p">(</span>
                <span class="n">experiment</span><span class="p">,</span>
                <span class="n">camera_id</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="o">=</span><span class="n">reference_object</span><span class="p">,</span>
                <span class="n">file_path</span><span class="o">=</span><span class="n">image_path</span><span class="p">,</span>
                <span class="n">pos_list</span><span class="o">=</span><span class="n">pos_list</span><span class="p">,</span>
                <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">use_reference</span><span class="o">=</span><span class="n">use_reference</span><span class="p">,</span>
                <span class="n">use_auto_focus</span><span class="o">=</span><span class="n">use_auto_focus</span><span class="p">,</span>
                <span class="n">meta_dict</span><span class="o">=</span><span class="n">meta_dict</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">return_dict</span></div>

    <span class="c1">################################################################################</span>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.scan_all_objects"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.scan_all_objects">[docs]</a>    <span class="k">def</span> <span class="nf">scan_all_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">,</span>
        <span class="n">plate_object</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">,</span>
        <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wait_after_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan all objects in dictionary.</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         sample_list: list with all objects to scan</span>

<span class="sd">         plate_object: object sample list belongs to</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">         repetition: counter for time lapse experiments</span>

<span class="sd">         wait_after_image: wait preferences as dictionary to determine whether</span>
<span class="sd">         to wait after execution</span>
<span class="sd">          Image: Wait after each image</span>

<span class="sd">          Plate: Reset wait status after each plate</span>

<span class="sd">          Repetition: Reset wait status after each repetition</span>

<span class="sd">          Status: Show last image and allow adjustments if True,</span>
<span class="sd">          enter fully automatic mode if False</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get settings from imaging_settings</span>
        <span class="n">load_between_objects</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;Load&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_LOAD</span>
        <span class="p">)</span>
        <span class="n">load_between_wells</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;LoadBetweenWells&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_LOADBETWEENWELLS</span>
        <span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Verbose&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_VERBOSE</span><span class="p">)</span>

        <span class="n">find_type</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FindType&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_FINDTYPE</span><span class="p">)</span>
        <span class="n">tile_image</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Define and if necessary create folder for images</span>
        <span class="n">object_folder</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Folder&quot;</span><span class="p">)</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">get_images_path</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">,</span> <span class="n">object_folder</span><span class="p">)</span>
        <span class="n">image_file_name_template</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FileName&quot;</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_file_name_template</span><span class="p">)</span>

        <span class="c1"># Get immersion water delivery object and initialize counter</span>
        <span class="n">add_immersion_water</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;AddImmersionWater&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_ADDIMERSIONWATER</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">add_immersion_water</span><span class="p">:</span>
            <span class="n">immersion_delivery_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;NameImmersionSystem&quot;</span><span class="p">)</span>
            <span class="n">immersion_delivery</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_immersionDeliverySystem</span><span class="p">(</span>
                <span class="n">immersion_delivery_name</span>
            <span class="p">)</span>
            <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">reset_counter</span><span class="p">()</span>
            <span class="n">counter_stop_value</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                <span class="s2">&quot;WellsBeforeAddImmersionWater&quot;</span>
            <span class="p">)</span>
            <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">set_counter_stop_value</span><span class="p">(</span><span class="n">counter_stop_value</span><span class="p">)</span>
            <span class="n">magnification_immersion_system</span> <span class="o">=</span> <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">get_magnification</span><span class="p">()</span>
            <span class="n">use_pump</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;UsePump&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEPUMP</span><span class="p">)</span>
            <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">get_water</span><span class="p">(</span>
                <span class="n">objective_magnification</span><span class="o">=</span><span class="n">magnification_immersion_system</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">automatic</span><span class="o">=</span><span class="n">use_pump</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># There is Zen&#39;s bug where the focus strategy keeps changing</span>
        <span class="c1"># to &quot;Z value defined by tile set up&quot; after being</span>
        <span class="c1"># repeatedly setup to &quot;None&quot;.</span>
        <span class="c1"># To find a workaround for this for now,</span>
        <span class="c1"># this piece of code loads the experiment into Zen software so that</span>
        <span class="c1"># all the settings are visible and then asks the user to confirm those settings.</span>
        <span class="c1"># Here user can change the focus strategy in Zen</span>
        <span class="c1"># and it stays &quot;None&quot; throughout the scan</span>
        <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>
        <span class="n">camera_id</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Camera&quot;</span><span class="p">)</span>
        <span class="c1"># The reason for startimg live mode and stopping it is</span>
        <span class="c1"># because in Zen there is no way of just loading</span>
        <span class="c1"># the experiment in Zen software where all the settings are visible</span>
        <span class="c1"># unless you call an operation on it</span>
        <span class="c1"># This way, from the UI side,</span>
        <span class="c1"># it loads the experiment without doing anything (instant start &amp; stop).</span>
        <span class="n">sample_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">live_mode_start</span><span class="p">(</span><span class="n">camera_id</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">)</span>
        <span class="n">sample_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">live_mode_stop</span><span class="p">(</span><span class="n">camera_id</span><span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">information_message</span><span class="p">(</span>
            <span class="s2">&quot;Execute Experiment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;In Zen, check the following settings: </span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;1) Focus Strategy is set to none</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;2) 1 tile region is set up with 66 tiles</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;3) 10x objective is checked in the light path</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;4) Hit live and check the brightness of TL</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;5) Save Experiment&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">current_well</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">load</span> <span class="o">=</span> <span class="n">load_between_objects</span>
        <span class="n">next_experiment_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_objects_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample_counter</span><span class="p">,</span> <span class="n">sample_object</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># move stage and focus to new object</span>
            <span class="k">if</span> <span class="n">current_well</span> <span class="o">!=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_well_object</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">add_immersion_water</span><span class="p">:</span>
                    <span class="n">immersion_delivery</span><span class="o">.</span><span class="n">count_and_get_water</span><span class="p">(</span>
                        <span class="n">objective_magnification</span><span class="o">=</span><span class="n">magnification_immersion_system</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">automatic</span><span class="o">=</span><span class="n">use_pump</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">load_between_wells</span><span class="p">:</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># noqa</span>
            <span class="c1"># Removed, stage will move in scan_single_ROI</span>
            <span class="c1"># _, _, _ = sampleObject.move_to_zero(load = load, verbose = verbose)</span>
            <span class="n">current_well</span> <span class="o">=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_well_object</span><span class="p">()</span>
            <span class="c1"># load = load_between_objects</span>

            <span class="n">meta_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;aics_well&quot;</span><span class="p">:</span> <span class="n">current_well</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                <span class="s2">&quot;aics_SampleType&quot;</span><span class="p">:</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_sample_type</span><span class="p">(),</span>
                <span class="s2">&quot;aics_SampleName&quot;</span><span class="p">:</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                <span class="s2">&quot;aics_barcode&quot;</span><span class="p">:</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_barcode</span><span class="p">(),</span>
                <span class="s2">&quot;aics_repetition&quot;</span><span class="p">:</span> <span class="n">repetition</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> out of </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">. Repetition: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_sample_type</span><span class="p">(),</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="n">sample_object</span><span class="o">.</span><span class="n">get_sample_type</span><span class="p">(),</span>
                    <span class="n">sample_counter</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">sample_list</span><span class="p">),</span>
                    <span class="n">plate_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                    <span class="n">repetition</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">return_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_single_ROI</span><span class="p">(</span>
                <span class="n">imaging_settings</span><span class="o">=</span><span class="n">imaging_settings</span><span class="p">,</span>
                <span class="n">experiment_dict</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                <span class="n">sample_object</span><span class="o">=</span><span class="n">sample_object</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="o">=</span><span class="n">plate_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">(),</span>
                <span class="n">image_path</span><span class="o">=</span><span class="n">image_path</span><span class="p">,</span>
                <span class="n">meta_dict</span><span class="o">=</span><span class="n">meta_dict</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">number_selected_postions</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">next_experiment_objects</span><span class="p">),</span>
                <span class="n">repetition</span><span class="o">=</span><span class="n">repetition</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span>

            <span class="c1"># Update the positions that are imaged - for substeps in 100X z-stack scans</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_object</span><span class="p">,</span> <span class="n">samples</span><span class="o">.</span><span class="n">Cell</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_last_experiment_object</span><span class="p">(</span><span class="n">sample_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
                <span class="c1"># Autosave</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

            <span class="c1"># Find objects for next experiment (e.g. cells within colonies)</span>
            <span class="c1"># check if output list was requested</span>
            <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Output&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="c1"># create tile</span>
                <span class="n">x_border_list</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[]</span>
                <span class="p">)</span>  <span class="c1"># list of border coordinates when tiles images are put together</span>
                <span class="n">y_border_list</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[]</span>
                <span class="p">)</span>  <span class="c1"># Used for segmentation later when recommending imageable locations</span>

                <span class="n">tile_image</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">tile_image</span><span class="p">,</span>
                            <span class="n">x_border_list</span><span class="p">,</span>
                            <span class="n">y_border_list</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">tile_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">imaging_settings</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">tile_image</span> <span class="o">=</span> <span class="n">sample_object</span><span class="o">.</span><span class="n">get_microscope</span><span class="p">()</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span>
                            <span class="n">image</span><span class="p">,</span> <span class="n">get_meta</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>  <span class="c1"># loads the image &amp; metadata</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">tile_image</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">raise</span>

                <span class="c1"># iterate over all requested output lists and find next objects</span>
                <span class="k">for</span> <span class="n">output_name</span><span class="p">,</span> <span class="n">output_class</span> <span class="ow">in</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">next_experiment_objects_list</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">create_output_objects_from_parent_object</span><span class="p">(</span>
                            <span class="n">find_type</span><span class="o">=</span><span class="n">find_type</span><span class="p">,</span>
                            <span class="n">sample_object</span><span class="o">=</span><span class="n">sample_object</span><span class="p">,</span>
                            <span class="n">imaging_settings</span><span class="o">=</span><span class="n">imaging_settings</span><span class="p">,</span>
                            <span class="n">image</span><span class="o">=</span><span class="n">tile_image</span><span class="p">,</span>
                            <span class="n">output_class</span><span class="o">=</span><span class="n">output_class</span><span class="p">,</span>
                            <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                            <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">next_experiment_objects</span> <span class="o">=</span> <span class="n">next_experiment_objects_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">plate_object</span><span class="o">.</span><span class="n">add_to_image_dir</span><span class="p">(</span>
                        <span class="n">list_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span> <span class="n">sample_object</span><span class="o">=</span><span class="n">next_experiment_objects</span>
                    <span class="p">)</span>
                    <span class="c1"># Populate objects for multiple wells/colonies/cells</span>
                    <span class="c1"># in one common dictionary</span>
                    <span class="n">next_experiment_objects_dict</span> <span class="o">=</span> <span class="n">next_experiment_objects_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">next_experiment_objects_dict</span><span class="p">:</span>
                        <span class="n">all_objects_dict</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_experiment_objects_dict</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span>

            <span class="c1"># Wait for user interaction before continuing</span>
            <span class="k">if</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">less_dialog</span><span class="p">:</span>
                    <span class="c1"># Fake user press (return False) if less dialog option is enabled</span>
                    <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">wait_message</span><span class="p">(</span>
                        <span class="s2">&quot;Remove image on display and continue imaging&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># close all images in microscope software</span>
            <span class="n">sample_object</span><span class="o">.</span><span class="n">remove_images</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">[</span><span class="s2">&quot;Continue&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">StopCollectingError</span><span class="p">(</span>
                    <span class="s2">&quot;Stop collecting </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_object</span><span class="o">.</span><span class="n">get_sample_type</span><span class="p">())</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_next_experiment_object</span><span class="p">(</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">],</span> <span class="n">all_objects_list</span>
        <span class="p">)</span>
        <span class="c1"># Autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

        <span class="c1"># Once the experiment with multiple objects is finished,</span>
        <span class="c1"># if interrupt is true, pickle and exit</span>
        <span class="c1"># If the experiment needs to be interrupted, save the positions and exit</span>
        <span class="n">pickle_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pickle_dict</span><span class="p">[</span><span class="s2">&quot;next_object_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_objects_dict</span>
        <span class="c1"># Pickle the reference object - needed for continuation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span>
        <span class="n">pickle_dict</span><span class="p">[</span><span class="s2">&quot;reference_object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span>
        <span class="c1"># Autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;Interrupt&quot;</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Interrupt&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">all_objects_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">while</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">samples</span><span class="o">.</span><span class="n">PlateHolder</span><span class="p">):</span>
                        <span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">microscope</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span>
            <span class="c1"># Generate the file name for the particular interrupt</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">get_recovery_settings_path</span><span class="p">(</span>
                <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;RecoverySettingsFilePath&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pickle_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
                <span class="n">message</span><span class="o">.</span><span class="n">stop_script</span><span class="p">(</span><span class="s2">&quot;Interruption Occurred. Data saved!&quot;</span><span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.segment_wells"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.segment_wells">[docs]</a>    <span class="k">def</span> <span class="nf">segment_wells</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">plate_holder_object</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">,</span>
        <span class="n">repetition</span><span class="p">,</span>
        <span class="n">wait_after_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a position list of segemented wells to a CSV file.</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_object: Plate Holder object containing all the information</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">         repetition: counter for time lapse experiments</span>

<span class="sd">         wait_after_image: wait preferences as dictionary to determine whether</span>
<span class="sd">         to wait after execution</span>
<span class="sd">          Image: Wait after each image</span>

<span class="sd">          Plate: Reset wait status after each plate</span>

<span class="sd">          Repetition: Reset wait status after each repetition</span>

<span class="sd">          Status: Show last image and allow adjustments if True,</span>
<span class="sd">          enter fully automatic mode if False</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all the well overview images in imageAICS format</span>
        <span class="n">source_folder</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;SourceFolder&quot;</span><span class="p">)</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">get_images_path</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">,</span> <span class="n">source_folder</span><span class="p">)</span>
        <span class="n">images_name_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.czi&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">images_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get the well names and plates</span>
        <span class="n">well_names_list</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Wells&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_WELLS</span><span class="p">)</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="c1"># To preserve the order defined in the preferences, we need to gp through</span>
        <span class="c1"># well list and create the image list in that particular order</span>
        <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">well_names_list</span><span class="p">:</span>
            <span class="c1"># Get the image file name associated with this well</span>
            <span class="k">for</span> <span class="n">image_filename</span> <span class="ow">in</span> <span class="n">images_name_list</span><span class="p">:</span>
                <span class="c1"># File name format = barcode_mag_date_wellid.czi</span>
                <span class="n">well_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">well_name</span> <span class="o">==</span> <span class="n">well</span><span class="p">:</span>
                    <span class="n">im_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">image_filename</span><span class="p">)</span>
                    <span class="n">aics_image</span> <span class="o">=</span> <span class="n">AICSImage</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">aics_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">aics_image</span><span class="o">.</span><span class="n">get_physical_pixel_size</span><span class="p">()</span>
                    <span class="n">image_meta</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;Size&quot;</span><span class="p">:</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="s2">&quot;aics_well&quot;</span><span class="p">:</span> <span class="n">well_name</span><span class="p">,</span>
                        <span class="s2">&quot;aics_filePath&quot;</span><span class="p">:</span> <span class="n">im_path</span><span class="p">,</span>
                        <span class="s2">&quot;PhysicalSizeX&quot;</span><span class="p">:</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;PhysicalSizeY&quot;</span><span class="p">:</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImageAICS</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">))</span>

        <span class="n">segmentation_info_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1"># Segment each image and store the points found</span>
        <span class="k">for</span> <span class="n">plate_counter</span><span class="p">,</span> <span class="p">(</span><span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images_list</span><span class="p">:</span>
                <span class="n">well_name</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get_meta</span><span class="p">(</span><span class="s2">&quot;aics_well&quot;</span><span class="p">)</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">image_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Remove the channel dimension before calling the location_picker</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Call segment well module to find imageable positions</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Filters&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">canny_sigma</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;CannySigma&quot;</span><span class="p">)</span>
                    <span class="n">canny_low_threshold</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;CannyLowThreshold&quot;</span><span class="p">)</span>
                    <span class="n">remove_small_holes_area_threshold</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                        <span class="s2">&quot;RemoveSmallHolesAreaThreshold&quot;</span>
                    <span class="p">)</span>
                    <span class="n">segmented_well</span> <span class="o">=</span> <span class="n">WellSegmentation</span><span class="p">(</span>
                        <span class="n">image_data</span><span class="p">,</span>
                        <span class="n">colony_filters_dict</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
                        <span class="n">canny_sigma</span><span class="o">=</span><span class="n">canny_sigma</span><span class="p">,</span>
                        <span class="n">canny_low_threshold</span><span class="o">=</span><span class="n">canny_low_threshold</span><span class="p">,</span>
                        <span class="n">remove_small_holes_area_threshold</span><span class="o">=</span><span class="n">remove_small_holes_area_threshold</span><span class="p">,</span>  <span class="c1"># noqa</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># if the preferences are not set, call with default ones</span>
                    <span class="n">segmented_well</span> <span class="o">=</span> <span class="n">WellSegmentation</span><span class="p">(</span>
                        <span class="n">image_data</span><span class="p">,</span> <span class="n">colony_filters_dict</span><span class="o">=</span><span class="n">filters</span>
                    <span class="p">)</span>

                <span class="n">segmented_well</span><span class="o">.</span><span class="n">segment_and_find_positions</span><span class="p">()</span>
                <span class="n">segmented_position_list</span> <span class="o">=</span> <span class="n">segmented_well</span><span class="o">.</span><span class="n">point_locations</span>

                <span class="n">well_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>
                <span class="n">segmentation_info_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">well_object</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
                            <span class="s2">&quot;position_list&quot;</span><span class="p">:</span> <span class="n">segmented_position_list</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="n">all_objects_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">position_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># List of lists to store the CSV file info</span>
        <span class="c1"># 1. To store the list of positions in the format specific</span>
        <span class="c1"># to Zen Blue software for 100X imaging.</span>
        <span class="n">position_list_for_csv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 2. To store positions and respective well IDs for post processing</span>
        <span class="c1"># (splitting and aligning)</span>
        <span class="n">image_location_list_for_csv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Initialize the csv file to store the positions after approval</span>
        <span class="p">(</span>
            <span class="n">position_csv_filepath</span><span class="p">,</span>
            <span class="n">position_wellid_csv_filepath</span><span class="p">,</span>
            <span class="n">failed_csv_filepath</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">get_position_csv_path</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">)</span>
        <span class="c1"># DefaultZ since the z position is not available at this point</span>
        <span class="n">default_z</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;PositionDefaultZ&quot;</span><span class="p">)</span>
        <span class="n">position_list_for_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Width&quot;</span><span class="p">,</span> <span class="s2">&quot;Height&quot;</span><span class="p">,</span> <span class="s2">&quot;ContourType&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">image_location_list_for_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;WellID&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Width&quot;</span><span class="p">,</span> <span class="s2">&quot;Height&quot;</span><span class="p">,</span> <span class="s2">&quot;ContourType&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Display each image for point approval</span>

            <span class="k">for</span> <span class="n">well_object</span> <span class="ow">in</span> <span class="n">segmentation_info_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">segmentation_info_dict</span><span class="p">[</span><span class="n">well_object</span><span class="p">][</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="n">segmented_position_list</span> <span class="o">=</span> <span class="n">segmentation_info_dict</span><span class="p">[</span><span class="n">well_object</span><span class="p">][</span>
                    <span class="s2">&quot;position_list&quot;</span>
                <span class="p">]</span>
                <span class="c1"># Store each image (with red +) in the target folder</span>
                <span class="c1"># location_list will be an empty list if user determines well is failed</span>
                <span class="n">location_list</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">set_interactive_positions</span><span class="p">(</span>
                    <span class="n">image_data</span><span class="p">,</span> <span class="n">segmented_position_list</span><span class="p">,</span> <span class="n">app</span>
                <span class="p">)</span>
                <span class="c1"># save the image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_segmented_image</span><span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="p">,</span>
                    <span class="n">image_data</span><span class="p">,</span>
                    <span class="n">location_list</span><span class="p">,</span>
                    <span class="n">plate_object</span><span class="p">,</span>
                    <span class="n">well_object</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">correct_location_list</span> <span class="o">=</span> <span class="n">convert_location_list</span><span class="p">(</span>
                    <span class="n">location_list</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="s2">&quot;czi&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Create cell objects and attach them properly to the parent object</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">output_name</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">output_class</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Output&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">output_class</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">new_objects_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">new_objects_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">correct_location_list</span><span class="p">:</span>
                    <span class="n">new_object_name</span> <span class="o">=</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{:04}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">new_object</span> <span class="o">=</span> <span class="n">class_</span><span class="p">(</span>
                        <span class="n">new_object_name</span><span class="p">,</span> <span class="p">[</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">well_object</span>
                    <span class="p">)</span>
                    <span class="n">new_objects_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span>
                    <span class="n">new_objects_dict</span><span class="p">[</span><span class="n">new_object_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_object</span>
                    <span class="c1"># Add P number to match the format being used in the pipeline</span>
                    <span class="n">position_name</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">position_number</span><span class="p">)</span>
                    <span class="c1"># The positions in this list are relative to the center of well</span>
                    <span class="c1"># To get the absolute stage coordinates</span>
                    <span class="c1"># we will have to add well.zero position + plate.zero position</span>
                    <span class="c1"># And we will also need to add the objective offset</span>
                    <span class="c1"># for 100X to correct for parcentricity</span>
                    <span class="n">x_obj_offset</span><span class="p">,</span> <span class="n">y_obj_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objective_offsets</span><span class="p">(</span>
                        <span class="n">plate_holder_object</span><span class="p">,</span> <span class="mi">100</span>
                    <span class="p">)</span>
                    <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">well_object</span><span class="o">.</span><span class="n">x_zero</span> <span class="o">+</span> <span class="n">well_object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">x_zero</span> <span class="o">+</span> <span class="n">x_obj_offset</span>
                    <span class="p">)</span>
                    <span class="n">y_offset</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">well_object</span><span class="o">.</span><span class="n">y_zero</span> <span class="o">+</span> <span class="n">well_object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">y_zero</span> <span class="o">+</span> <span class="n">y_obj_offset</span>
                    <span class="p">)</span>
                    <span class="n">x_pos</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_offset</span>
                    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_offset</span>
                    <span class="n">pos_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_name</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">default_z</span><span class="p">]</span>
                    <span class="n">well_info</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">position_name</span><span class="p">,</span>
                        <span class="n">well_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                        <span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">default_z</span><span class="p">,</span>
                    <span class="p">]</span>
                    <span class="n">position_list_for_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_info</span><span class="p">)</span>
                    <span class="n">image_location_list_for_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">well_info</span><span class="p">)</span>
                    <span class="n">position_number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">well_object</span><span class="o">.</span><span class="n">add_samples</span><span class="p">(</span><span class="n">new_objects_dict</span><span class="p">)</span>
                <span class="n">plate_object</span><span class="o">.</span><span class="n">add_to_image_dir</span><span class="p">(</span>
                    <span class="n">list_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span> <span class="n">sample_object</span><span class="o">=</span><span class="n">new_objects_list</span>
                <span class="p">)</span>
                <span class="n">all_objects_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_objects_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">new_objects_dict</span><span class="p">:</span>
                    <span class="n">all_objects_dict</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_objects_dict</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># write each position to the file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">position_csv_filepath</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">position_file</span><span class="p">:</span>
                <span class="n">position_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
                    <span class="n">position_file</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
                    <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                    <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">position_list_for_csv</span><span class="p">:</span>
                    <span class="n">position_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">position_wellid_csv_filepath</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">position_wellid_file</span><span class="p">:</span>
                <span class="n">position_wellid_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
                    <span class="n">position_wellid_file</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
                    <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                    <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">position_wellid</span> <span class="ow">in</span> <span class="n">image_location_list_for_csv</span><span class="p">:</span>
                    <span class="n">position_wellid_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">position_wellid</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">failed_csv_filepath</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fail_position_file</span><span class="p">:</span>
                <span class="n">fail_position_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
                    <span class="n">fail_position_file</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span>
                <span class="p">)</span>
                <span class="n">fail_position_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;well_id&quot;</span><span class="p">,</span> <span class="s2">&quot;plate_barcode&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">failed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_wells</span><span class="p">:</span>
                    <span class="n">fail_position_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">failed</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">failed</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">barcode</span><span class="p">]</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add_next_experiment_object</span><span class="p">(</span>
            <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">],</span> <span class="n">all_objects_list</span>
        <span class="p">)</span>
        <span class="c1"># Autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
        <span class="n">pickle_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pickle_dict</span><span class="p">[</span><span class="s2">&quot;next_object_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_objects_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span>
        <span class="n">pickle_dict</span><span class="p">[</span><span class="s2">&quot;reference_object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span>
        <span class="c1"># Autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span>
        <span class="c1"># Once the experiment with multiple objects is finished,</span>
        <span class="c1"># if interrupt is true, pickle and exit</span>
        <span class="c1"># If the experiment needs to be interrupted, save the positions and exit</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;Interrupt&quot;</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Interrupt&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">all_objects_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># Remove the communication object because it can&#39;t be pickled</span>
                <span class="k">while</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">samples</span><span class="o">.</span><span class="n">PlateHolder</span><span class="p">):</span>
                        <span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">microscope</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span>
            <span class="c1"># Generate the file name for the particular interrupt</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">get_recovery_settings_path</span><span class="p">(</span>
                <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;RecoverySettingsFilePath&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pickle_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
                <span class="n">message</span><span class="o">.</span><span class="n">stop_script</span><span class="p">(</span><span class="s2">&quot;Interruption Occurred. Data saved!&quot;</span><span class="p">)</span>
        <span class="n">daily_folder</span> <span class="o">=</span> <span class="n">get_valid_path_from_prefs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="s2">&quot;PathDailyFolder&quot;</span><span class="p">,</span> <span class="n">search_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">pos_list_saver</span> <span class="o">=</span> <span class="n">PositionWriter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;Info&quot;</span><span class="p">][</span><span class="s2">&quot;System&quot;</span><span class="p">],</span>
            <span class="n">plate_object</span><span class="o">.</span><span class="n">get_barcode</span><span class="p">(),</span>
            <span class="n">daily_folder</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">position_list_for_csv</span> <span class="o">=</span> <span class="n">pos_list_saver</span><span class="o">.</span><span class="n">convert_to_stage_coords</span><span class="p">(</span>
            <span class="n">positions_list</span><span class="o">=</span><span class="n">position_list_for_csv</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">pos_list_saver</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">converted</span><span class="o">=</span><span class="n">position_list_for_csv</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;PathDummy&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MicroscopeAutomation.get_objective_offsets"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.get_objective_offsets">[docs]</a>    <span class="k">def</span> <span class="nf">get_objective_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">magnification</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to return the objective offsets</span>

<span class="sd">        Input:</span>
<span class="sd">         plate_holder_object: Plate Holder object containing all the information</span>

<span class="sd">         magnification: integer defining which objective to get offsets for</span>

<span class="sd">        Output:</span>
<span class="sd">         x and y offsets for objectives</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objective_changer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">x_obj_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y_obj_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">component_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">microscope_components_ordered_dict</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">component_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">hardware_components</span><span class="o">.</span><span class="n">ObjectiveChanger</span><span class="p">):</span>
                <span class="n">objective_changer</span> <span class="o">=</span> <span class="n">component</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">objective</span><span class="p">,</span> <span class="n">information</span> <span class="ow">in</span> <span class="n">objective_changer</span><span class="o">.</span><span class="n">objective_information</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">information</span><span class="p">[</span><span class="s2">&quot;magnification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">magnification</span><span class="p">:</span>
                <span class="n">x_obj_offset</span> <span class="o">=</span> <span class="n">information</span><span class="p">[</span><span class="s2">&quot;x_offset&quot;</span><span class="p">]</span>
                <span class="n">y_obj_offset</span> <span class="o">=</span> <span class="n">information</span><span class="p">[</span><span class="s2">&quot;y_offset&quot;</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">x_obj_offset</span><span class="p">,</span> <span class="n">y_obj_offset</span></div>

    <span class="c1">############################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.scan_plate"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.scan_plate">[docs]</a>    <span class="k">def</span> <span class="nf">scan_plate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">plate_holder_object</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">,</span>
        <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wait_after_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan selected wells in plate to create overview.</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">         repetition: counter for time lapse experiments</span>

<span class="sd">         wait_after_image: wait preferences as dictionary to determine whether</span>
<span class="sd">         to wait after execution</span>
<span class="sd">          Image: Wait after each image</span>

<span class="sd">          Plate: Reset wait status after each plate</span>

<span class="sd">          Repetition: Reset wait status after each repetition</span>

<span class="sd">          Status: Show last image and allow adjustments if True,</span>
<span class="sd">          enter fully automatic mode if False</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get names of wells to scan</span>
        <span class="n">well_names_list</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Wells&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_WELLS</span><span class="p">)</span>

        <span class="c1"># iterate through all plates on plate holder</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plate_counter</span><span class="p">,</span> <span class="p">(</span><span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continue&quot;</span>
                    <span class="ow">and</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;ObjectsDict&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recover_previous_settings</span><span class="p">(</span>
                        <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">,</span> <span class="n">experiment</span>
                    <span class="p">)</span>

                <span class="c1"># get objects for wells in well_names_list</span>
                <span class="n">wells_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">plate_object</span><span class="o">.</span><span class="n">get_well</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">well_name</span> <span class="ow">in</span> <span class="n">well_names_list</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan_all_objects</span><span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="p">,</span>
                    <span class="n">sample_list</span><span class="o">=</span><span class="n">wells_list</span><span class="p">,</span>
                    <span class="n">plate_object</span><span class="o">=</span><span class="n">plate_object</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                    <span class="n">repetition</span><span class="o">=</span><span class="n">repetition</span><span class="p">,</span>
                    <span class="n">wait_after_image</span><span class="o">=</span><span class="n">wait_after_image</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Wait for user interaction before continuing</span>
            <span class="k">if</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Plate&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]:</span>
                <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Plate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">wait_message</span><span class="p">(</span>
                    <span class="s2">&quot;New plate: do you want to stop after the next image?&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">StopCollectingError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">error_dialog</span><span class="p">()</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.run_macro"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.run_macro">[docs]</a>    <span class="k">def</span> <span class="nf">run_macro</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">plate_holder_object</span><span class="p">,</span>
        <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wait_after_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         experiment: not used, necessary for compatibility</span>

<span class="sd">         repetition: not used, necessary for compatibility</span>

<span class="sd">         wait_after_image: not used, necessary for compatibility</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get name of macro within microscope software</span>
        <span class="n">macro_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;MacroName&quot;</span><span class="p">)</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;MacroParams&quot;</span><span class="p">)</span>

        <span class="c1"># Check for no params passed in preferences file</span>
        <span class="c1"># No param key, empty string, empty list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">run_macro</span><span class="p">(</span><span class="n">macro_name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># we require params as list, even if there is only one element</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="c1"># Ensure we parse if user gives # convention from ImageAICS</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">ImageAICS</span><span class="p">()</span>
            <span class="n">i</span><span class="o">.</span><span class="n">add_meta</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;aics_barcode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_first_barcode_from_plateholderobject</span><span class="p">(</span>
                        <span class="n">plate_holder_object</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">add_meta</span><span class="p">({</span><span class="s2">&quot;aics_microscope&quot;</span><span class="p">:</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">parse_file_template</span><span class="p">(</span><span class="n">param_list</span><span class="p">)]</span>

        <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span><span class="o">.</span><span class="n">run_macro</span><span class="p">(</span><span class="n">macro_name</span><span class="p">,</span> <span class="n">param_list</span><span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.read_first_barcode_from_plateholderobject"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.read_first_barcode_from_plateholderobject">[docs]</a>    <span class="k">def</span> <span class="nf">read_first_barcode_from_plateholderobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given plate_holder_object that can store one plate,</span>
<span class="sd">        return that plate&#39;s barcode.</span>

<span class="sd">        Input:</span>
<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">        Output:</span>
<span class="sd">         barcode: barcode of plate in plate_holder_object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">barcode</span></div>

<div class="viewcode-block" id="MicroscopeAutomation.recover_previous_settings"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.recover_previous_settings">[docs]</a>    <span class="k">def</span> <span class="nf">recover_previous_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">,</span> <span class="n">experiment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recover the the objects created in the last experiment</span>
<span class="sd">        and attach them to the right objects.</span>

<span class="sd">        Input:</span>
<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         plate_object: object of class plate</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_experiment_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">next_experiment_objects_dict</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;ObjectsDict&quot;</span><span class="p">]</span>
        <span class="c1"># Add the microscope object to each plateholder that was removed</span>
        <span class="c1"># when the dict was pickled</span>
        <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">next_experiment_objects_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">while</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="p">,</span> <span class="n">samples</span><span class="o">.</span><span class="n">PlateHolder</span><span class="p">):</span>
                    <span class="nb">object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">microscope</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">microscope</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">container</span>
        <span class="c1"># Add the object to the plates</span>
        <span class="k">for</span> <span class="nb">object</span> <span class="ow">in</span> <span class="n">next_experiment_objects_dict</span><span class="p">:</span>
            <span class="n">next_experiment_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_experiment_objects_dict</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span>
        <span class="n">list_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Input&quot;</span><span class="p">]</span>
        <span class="n">plate_object</span><span class="o">.</span><span class="n">add_to_image_dir</span><span class="p">(</span>
            <span class="n">list_name</span><span class="o">=</span><span class="n">list_name</span><span class="p">,</span> <span class="n">sample_object</span><span class="o">=</span><span class="n">next_experiment_objects</span>
        <span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.save_segmented_image"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.save_segmented_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_segmented_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">imaging_settings</span><span class="p">,</span> <span class="n">image_data</span><span class="p">,</span> <span class="n">location_list</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">,</span> <span class="n">well_object</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A simple function to save the positions that were a result of</span>
<span class="sd">        well segmentation and represent which positions will be imaged in 100X</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: yaml preferences</span>

<span class="sd">         image_data: pixel data of the image</span>

<span class="sd">         location_list: list of positions approved by the user</span>

<span class="sd">         plate_object: plate object</span>

<span class="sd">         well_object: well object associated with the image</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine the folder where the images will be stored</span>
        <span class="n">segmented_images_folder</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Folder&quot;</span><span class="p">)</span>
        <span class="n">segmented_image_dir</span> <span class="o">=</span> <span class="n">get_images_path</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">,</span> <span class="n">segmented_images_folder</span><span class="p">)</span>
        <span class="n">image_file_name_template</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FileName&quot;</span><span class="p">)</span>

        <span class="n">microscope_object</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">microscope</span>
        <span class="c1"># make a copy because the pixel values are being changed only for saving part</span>
        <span class="n">image_data_save</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Plot the positions on the image as a set of white pixels</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">location_list</span><span class="p">:</span>
            <span class="n">pixel_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">image_data_save</span><span class="p">[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">pixel_width</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">pixel_width</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">pixel_width</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">pixel_width</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">image_aics</span> <span class="o">=</span> <span class="n">ImageAICS</span><span class="p">(</span><span class="n">image_data_save</span><span class="p">)</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">microscope_object</span><span class="o">.</span><span class="n">get_information</span><span class="p">()</span>
        <span class="c1"># Add relevant meta data</span>
        <span class="n">image_aics</span><span class="o">.</span><span class="n">add_meta</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;aics_objectiveMagnification&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="n">info_dict</span><span class="p">[</span><span class="n">plate_object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">objective_changer_id</span><span class="p">][</span>
                        <span class="s2">&quot;magnification&quot;</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">image_aics</span><span class="o">.</span><span class="n">add_meta</span><span class="p">({</span><span class="s2">&quot;aics_well&quot;</span><span class="p">:</span> <span class="n">well_object</span><span class="o">.</span><span class="n">get_name</span><span class="p">()})</span>
        <span class="n">image_aics</span><span class="o">.</span><span class="n">add_meta</span><span class="p">({</span><span class="s2">&quot;aics_barcode&quot;</span><span class="p">:</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_barcode</span><span class="p">()})</span>
        <span class="n">date_short</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_aics</span><span class="o">.</span><span class="n">add_meta</span><span class="p">({</span><span class="s2">&quot;aics_dateStartShort&quot;</span><span class="p">:</span> <span class="n">date_short</span><span class="p">})</span>
        <span class="c1"># Create the file path based on the meta data and save the image as a tiff file</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">image_aics</span><span class="o">.</span><span class="n">create_file_name</span><span class="p">(</span>
            <span class="p">(</span><span class="n">segmented_image_dir</span><span class="p">,</span> <span class="n">image_file_name_template</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">imsave</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">image_data_save</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span></div>

    <span class="c1">############################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.scan_samples"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.scan_samples">[docs]</a>    <span class="k">def</span> <span class="nf">scan_samples</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">imaging_settings</span><span class="p">,</span>
        <span class="n">plate_holder_object</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">,</span>
        <span class="n">repetition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">wait_after_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step through all plates and call scan_all_objects.</span>

<span class="sd">        Input:</span>
<span class="sd">         imaging_settings: dictionary with preferences</span>

<span class="sd">         plate_holder_object: object of type PlateHolder</span>
<span class="sd">         from module sample with well information</span>

<span class="sd">         experiment: dictionary with keys &#39;Experiment&#39;, Repetitions&#39;, &#39;Input&#39;,</span>
<span class="sd">         &#39;Output&#39;, &#39;WorkflowList&#39;, &#39;WorflowType&#39;, &#39;ObjectsDict&#39; and &#39;OriginalWorkflow&#39;</span>

<span class="sd">         repetition: counter for time lapse experiments</span>

<span class="sd">         wait_after_image: wait preferences as dictionary to determine whether</span>
<span class="sd">         to wait after execution</span>
<span class="sd">          Image: Wait after each image</span>

<span class="sd">          Plate: Reset wait status after each plate</span>

<span class="sd">          Repetition: Reset wait status after each repetition</span>

<span class="sd">          Status: Show last image and allow adjustments if True,</span>
<span class="sd">          enter fully automatic mode if False</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>
        <span class="n">list_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Input&quot;</span><span class="p">]</span>

        <span class="c1"># Iterate through all plates on plate holder</span>
        <span class="k">for</span> <span class="n">plate_counter</span><span class="p">,</span> <span class="p">(</span><span class="n">plate_name</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sample_list</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_from_image_dir</span><span class="p">(</span><span class="n">list_name</span><span class="p">)</span>
            <span class="n">current_samples</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>

            <span class="n">workflow_list</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowList&quot;</span><span class="p">]</span>

            <span class="c1"># Recover the positions that were imaged &amp; the ones that need to be imaged</span>
            <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continue&quot;</span><span class="p">:</span>

                <span class="c1"># Recover positions to be imaged next</span>
                <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;ObjectsDict&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recover_previous_settings</span><span class="p">(</span>
                        <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">plate_object</span><span class="p">,</span> <span class="n">experiment</span>
                    <span class="p">)</span>

                <span class="c1"># Readjust the focus if continuing from scanCells</span>
                <span class="c1"># To readjust the focus get the experiment name</span>
                <span class="c1"># of the focusing block from the pref file</span>
                <span class="n">update_z_function_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                    <span class="s2">&quot;DefineFocusBlockName&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">update_z_function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">update_z_function_name</span> <span class="o">=</span> <span class="s2">&quot;UpdatePlateWellZero_100x&quot;</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_parent_prefs</span><span class="p">()</span><span class="o">.</span><span class="n">get_pref_as_meta</span><span class="p">(</span>
                    <span class="n">update_z_function_name</span>
                <span class="p">)</span>
                <span class="n">workflow</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_parent_prefs</span><span class="p">()</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Workflow&quot;</span><span class="p">)</span>
                <span class="n">update_plate_exp</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">update_plate_exp</span>
                    <span class="k">for</span> <span class="n">update_plate_exp</span> <span class="ow">in</span> <span class="n">workflow</span>
                    <span class="k">if</span> <span class="n">update_plate_exp</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">update_z_function_name</span>
                <span class="p">]</span>
                <span class="n">experiment_dict</span> <span class="o">=</span> <span class="n">update_plate_exp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">experiment_dict</span><span class="p">[</span><span class="s2">&quot;RecoverySettingsFilePath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span>
                    <span class="s2">&quot;RecoverySettingsFilePath&quot;</span>
                <span class="p">]</span>
                <span class="n">experiment_dict</span><span class="p">[</span><span class="s2">&quot;WorkflowList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowList&quot;</span><span class="p">]</span>
                <span class="n">experiment_dict</span><span class="p">[</span><span class="s2">&quot;OriginalWorkflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;OriginalWorkflow&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">update_z_function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">workflow_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_plate_z_zero</span><span class="p">(</span>
                        <span class="n">settings</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">experiment_dict</span>
                    <span class="p">)</span>

                <span class="c1"># Extract the sample list</span>
                <span class="n">sample_list</span> <span class="o">=</span> <span class="n">plate_object</span><span class="o">.</span><span class="n">get_from_image_dir</span><span class="p">(</span><span class="n">list_name</span><span class="p">)</span>
                <span class="n">current_samples</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>
                <span class="c1"># Update sample list by removing positions that were imaged already</span>
                <span class="n">last_exp_objects</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;LastExpObjects&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sample_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">last_exp_objects</span><span class="p">:</span>
                            <span class="n">current_samples</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan_all_objects</span><span class="p">(</span>
                    <span class="n">imaging_settings</span><span class="p">,</span>
                    <span class="n">sampleList</span><span class="o">=</span><span class="n">current_samples</span><span class="p">,</span>
                    <span class="n">plateObject</span><span class="o">=</span><span class="n">plate_object</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                    <span class="n">repetition</span><span class="o">=</span><span class="n">repetition</span><span class="p">,</span>
                    <span class="n">wait_after_image</span><span class="o">=</span><span class="n">wait_after_image</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Update the reference object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reference_object</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_reference_object</span><span class="p">()</span>
        <span class="c1"># Autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.validate_experiment"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.validate_experiment">[docs]</a>    <span class="k">def</span> <span class="nf">validate_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imaging_settings</span><span class="p">,</span> <span class="n">microscope_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the experiment is not defined in Zen, give the user two tries to create it</span>

<span class="sd">        Input:</span>
<span class="sd">         image_settings: preferences from the yaml file</span>

<span class="sd">         microscope_object: microscope hardware object</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize a Experiment object</span>
        <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Experiment&quot;</span><span class="p">)</span>

        <span class="c1"># Check if the experiment is actually needed</span>
        <span class="c1"># (for example, segmentation doesn&#39;t need a Zen experiment)</span>
        <span class="k">if</span> <span class="n">experiment_name</span> <span class="o">!=</span> <span class="s2">&quot;NoExperiment&quot;</span><span class="p">:</span>
            <span class="n">experiment_path</span> <span class="o">=</span> <span class="n">get_experiment_path</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">)</span>
            <span class="n">zen_experiment</span> <span class="o">=</span> <span class="n">hardware_components</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span>
                <span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">,</span> <span class="n">microscope_object</span>
            <span class="p">)</span>
            <span class="c1"># Check if experiment exists in Zen blue</span>
            <span class="c1"># Give the user 2 tries to add the experiment in zen</span>
            <span class="n">valid_experiment</span> <span class="o">=</span> <span class="n">zen_experiment</span><span class="o">.</span><span class="n">validate_experiment</span><span class="p">()</span>
            <span class="n">num_try</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">valid_experiment</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">num_try</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">information_message</span><span class="p">(</span>
                    <span class="s2">&quot;Error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;The experiment &quot;</span>
                    <span class="o">+</span> <span class="n">experiment_name</span>
                    <span class="o">+</span> <span class="s2">&quot; is not defined in the Zen Software. Please add it now and &quot;</span>
                    <span class="s2">&quot;continue the experiment&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">valid_experiment</span> <span class="o">=</span> <span class="n">zen_experiment</span><span class="o">.</span><span class="n">validate_experiment</span><span class="p">()</span>
                <span class="n">num_try</span> <span class="o">=</span> <span class="n">num_try</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">valid_experiment</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">stop_script</span><span class="p">(</span>
                    <span class="s2">&quot;The Experiment &quot;</span>
                    <span class="o">+</span> <span class="n">experiment_name</span>
                    <span class="o">+</span> <span class="s2">&quot; is not defined in the ZEN software. Exiting the software.&quot;</span>
                <span class="p">)</span></div>

    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.control_autofocus"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.control_autofocus">[docs]</a>    <span class="k">def</span> <span class="nf">control_autofocus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_object</span><span class="p">,</span> <span class="n">imaging_settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Switch on/off autofocus.</span>

<span class="sd">        Input:</span>
<span class="sd">         sample_object: object of class inherited from ImagingSystem</span>

<span class="sd">         imaging_settings: settings derived from preferences file</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_auto_focus</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
            <span class="s2">&quot;UseAutoFocus&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_USEAUTOFOCUS</span>
        <span class="p">)</span>
        <span class="n">sample_object</span><span class="o">.</span><span class="n">set_use_autofocus</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="n">use_auto_focus</span><span class="p">)</span></div>

    <span class="c1">################################################################################</span>
    <span class="c1">#</span>
    <span class="c1"># Main function for microscope automation.</span>
    <span class="c1"># Start this function to start automation.</span>
    <span class="c1">#</span>
    <span class="c1">################################################################################</span>

<div class="viewcode-block" id="MicroscopeAutomation.microscope_automation"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.MicroscopeAutomation.microscope_automation">[docs]</a>    <span class="k">def</span> <span class="nf">microscope_automation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Main script for Microscope automation.</span>

<span class="sd">        Input:</span>
<span class="sd">         none</span>

<span class="sd">        Output:</span>
<span class="sd">         none</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># start local logging</span>
        <span class="n">error_handling</span><span class="o">.</span><span class="n">setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;automation protocol started&quot;</span><span class="p">)</span>

        <span class="c1"># setup microscope</span>
        <span class="n">microscope_object</span> <span class="o">=</span> <span class="n">setup_microscope</span><span class="o">.</span><span class="n">setup_microscope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>

        <span class="c1"># get list of experiments to perform on given plate</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Workflow&quot;</span><span class="p">)</span>

        <span class="c1"># Setting up continuation</span>
        <span class="c1"># Dialog box</span>
        <span class="n">continue_check_box_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Start new workflow&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Continue last workflow&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">continue_dialog_box</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">check_box_message</span><span class="p">(</span>
            <span class="s2">&quot;Please select workflow type:&quot;</span><span class="p">,</span> <span class="n">continue_check_box_list</span><span class="p">,</span> <span class="n">return_code</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">continue_dialog_box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">workflow_type</span> <span class="o">=</span> <span class="s2">&quot;new&quot;</span>
        <span class="k">elif</span> <span class="n">continue_dialog_box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">workflow_type</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>

        <span class="c1"># Update workflow based on workflow type</span>
        <span class="k">if</span> <span class="n">workflow_type</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span>
            <span class="n">check_box_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> x </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;Repetitions&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">workflow</span>
            <span class="p">]</span>
            <span class="n">new_check_box_list</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">check_box_message</span><span class="p">(</span>
                <span class="s2">&quot;Please select experiment to execute:&quot;</span><span class="p">,</span>
                <span class="n">check_box_list</span><span class="p">,</span>
                <span class="n">return_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">workflow</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">workflow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_check_box_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="p">]</span>
            <span class="n">workflow_experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">]</span>
            <span class="n">original_workflow</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">workflow_experiments</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Read the preference file and find which to continue from</span>
            <span class="n">workflow_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
                <span class="n">workflow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">])</span>
            <span class="n">continue_experiment</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">pull_down_select_dialog</span><span class="p">(</span>
                <span class="n">workflow_list</span><span class="p">,</span> <span class="s2">&quot;Please select the experiment to continue from:&quot;</span>
            <span class="p">)</span>
            <span class="n">workflow_experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">]</span>
            <span class="n">original_workflow</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">workflow_experiments</span><span class="p">)</span>
            <span class="c1"># Update the experiment list with experiments starting</span>
            <span class="c1"># from continue_experiment and the ones after it</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">continue_experiment</span><span class="p">:</span>
                    <span class="n">workflow_experiments</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># Update the workflow with new sets of experiments</span>
            <span class="n">new_workflow</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">workflow_experiments</span><span class="p">:</span>
                    <span class="n">new_workflow</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">workflow</span> <span class="o">=</span> <span class="n">new_workflow</span>

            <span class="c1"># Ask to pick the file again if the user picks blank file name</span>
            <span class="n">pickle_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="n">pickle_file</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># Ask user which pickle file to recover settings from</span>
                <span class="n">file_dir</span> <span class="o">=</span> <span class="n">get_valid_path_from_prefs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="s2">&quot;RecoverySettingsFilePath&quot;</span><span class="p">,</span> <span class="n">search_dir</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">pickle_file</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">file_select_dialog</span><span class="p">(</span>
                    <span class="n">file_dir</span><span class="p">,</span>
                    <span class="n">filePattern</span><span class="o">=</span><span class="s2">&quot;*.pickle&quot;</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Please select the file to recover settings from.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Recover the objects dictionary</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">pickle_file</span><span class="p">))</span>
            <span class="p">(</span>
                <span class="n">next_objects_dict</span><span class="p">,</span>
                <span class="n">reference_object</span><span class="p">,</span>
                <span class="n">last_experiment_objects</span><span class="p">,</span>
                <span class="n">hardware_status_dict</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">recover_objects</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="c1"># Set up the reference object</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">microscope_object</span><span class="o">.</span><span class="n">microscope_components_ordered_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">hardware_components</span><span class="o">.</span><span class="n">AutoFocus</span><span class="p">):</span>
                    <span class="n">reference_object</span><span class="o">.</span><span class="n">microscope</span> <span class="o">=</span> <span class="n">microscope_object</span>
                    <span class="n">reference_object</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">microscope</span> <span class="o">=</span> <span class="n">microscope_object</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">set_focus_reference_obj</span><span class="p">(</span><span class="n">reference_object</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># Set up the hardware status in the microscope object</span>
            <span class="n">microscope_object</span><span class="o">.</span><span class="n">objective_ready_dict</span> <span class="o">=</span> <span class="n">hardware_status_dict</span>
            <span class="c1"># Set up objects dict for backtracking - remove unnecessary objects</span>
            <span class="c1"># won&#39;t work for planned interruption workflow</span>
            <span class="c1"># so only do it if its of the type unplanned</span>
            <span class="c1"># planned interruptions dict value are objects, unplanned ones are list</span>
            <span class="n">objects_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_objects_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">previous_experiment</span> <span class="o">=</span> <span class="n">workflow_list</span><span class="p">[</span>
                        <span class="n">workflow_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">continue_experiment</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">]</span>
                    <span class="n">objects_list</span> <span class="o">=</span> <span class="n">next_objects_dict</span><span class="p">[</span><span class="n">previous_experiment</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects_list</span><span class="p">:</span>
                        <span class="n">objects_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">obj</span><span class="o">.</span><span class="n">get_name</span><span class="p">():</span> <span class="n">obj</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">objects_dict</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objects_dict</span> <span class="o">=</span> <span class="n">next_objects_dict</span>

        <span class="c1"># setup plate holder with plate, wells, and colonies</span>
        <span class="n">colony_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;AddColonies&quot;</span> <span class="ow">in</span> <span class="n">workflow_experiments</span><span class="p">:</span>
            <span class="n">add_colonies_prefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref_as_meta</span><span class="p">(</span><span class="s2">&quot;AddColonies&quot;</span><span class="p">)</span>
            <span class="n">colony_file_directory</span> <span class="o">=</span> <span class="n">get_colony_dir_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">add_colonies_prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;FileName&quot;</span><span class="p">)</span>
            <span class="n">colony_file</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">file_select_dialog</span><span class="p">(</span>
                <span class="n">colony_file_directory</span><span class="p">,</span>
                <span class="n">filePattern</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Please select csv file with colony data.&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">experiment</span>
                <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">workflow</span>
                <span class="k">if</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AddColonies&quot;</span>
            <span class="p">]</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">workflow_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;AddColonies&quot;</span><span class="p">)</span>

        <span class="n">plate_holder_object</span> <span class="o">=</span> <span class="n">setup_plate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="n">colony_file</span><span class="p">,</span> <span class="n">microscope_object</span><span class="p">)</span>

        <span class="c1"># Set up the Daily folder with plate barcode</span>
        <span class="c1"># Currently only one plate supported so barcode is extracted from that</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>
        <span class="n">barcode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Set up the high level folder with plate barcode</span>
        <span class="n">get_daily_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
        <span class="c1"># Set up Image Folders and Sub Folders</span>
        <span class="n">image_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Get all the preferences</span>
        <span class="k">for</span> <span class="n">pref_block</span><span class="p">,</span> <span class="n">func_prefs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_prefs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pref</span><span class="p">,</span> <span class="n">pref_value</span> <span class="ow">in</span> <span class="n">func_prefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">pref</span> <span class="o">==</span> <span class="s2">&quot;Folder&quot;</span><span class="p">:</span>
                        <span class="c1"># Set up Folders for each function block</span>
                        <span class="c1"># Add set up for a single folder as well as a list of folders</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pref_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">image_folder</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">pref_value</span><span class="p">:</span>
                                <span class="n">image_folder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">get_images_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">image_folder</span> <span class="o">=</span> <span class="n">get_images_path</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="n">pref_value</span><span class="p">,</span> <span class="n">barcode</span>
                            <span class="p">)</span>
                    <span class="c1"># Set up the subfolders for each image folder</span>
                    <span class="k">if</span> <span class="n">pref</span> <span class="o">==</span> <span class="s2">&quot;SubFolders&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">subfolder</span> <span class="ow">in</span> <span class="n">pref_value</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_folder</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">image_folder</span><span class="p">:</span>
                                    <span class="n">set_up_subfolders</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">set_up_subfolders</span><span class="p">(</span><span class="n">image_folder</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>

        <span class="c1"># set-up meta data file object</span>
        <span class="n">meta_data_file_path</span> <span class="o">=</span> <span class="n">get_meta_data_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
        <span class="n">meta_data_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;MetaDataFormat&quot;</span><span class="p">)</span>
        <span class="n">meta_data_file_object</span> <span class="o">=</span> <span class="n">MetaDataFile</span><span class="p">(</span><span class="n">meta_data_file_path</span><span class="p">,</span> <span class="n">meta_data_format</span><span class="p">)</span>
        <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">add_meta_data_file</span><span class="p">(</span><span class="n">meta_data_file_object</span><span class="p">)</span>

        <span class="c1"># cycle through all plates</span>
        <span class="n">plate_objects</span> <span class="o">=</span> <span class="n">plate_holder_object</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">plate_object</span> <span class="ow">in</span> <span class="n">plate_objects</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># execute each measurement based on experiment in workflow</span>
            <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">workflow</span><span class="p">:</span>
                <span class="c1"># attach additional parameters to experiment to propagate</span>
                <span class="c1"># into all the scanning functions</span>
                <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_experiments</span>
                <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;OriginalWorkflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_workflow</span>
                <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;WorkflowType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_type</span>
                <span class="n">workflow_interrupt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;WorkflowInterrupt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">workflow_interrupt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">workflow_interrupt</span> <span class="o">==</span> <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]:</span>
                        <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Interrupt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Interrupt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">recovery_settings_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                    <span class="s2">&quot;RecoverySettingsFilePath&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">recovery_settings_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;RecoverySettingsFilePath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_settings_file_path</span>
                <span class="k">if</span> <span class="n">workflow_type</span> <span class="o">==</span> <span class="s2">&quot;continue&quot;</span><span class="p">:</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;ObjectsDict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objects_dict</span>
                    <span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;LastExpObjects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_experiment_objects</span>
                <span class="n">imaging_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref_as_meta</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_experiment</span><span class="p">(</span><span class="n">imaging_settings</span><span class="p">,</span> <span class="n">microscope_object</span><span class="p">)</span>

                <span class="c1"># read wait preferences as dictionary to determine whether to wait after</span>
                <span class="c1"># Image: Wait after each image</span>
                <span class="c1"># Plate: Reset wait status after each plate</span>
                <span class="c1"># Repetition: Reset wait status after each repetition</span>
                <span class="n">wait_after_image</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Wait&quot;</span><span class="p">)</span>
                <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span>

                <span class="c1"># set blocking/non-blocking for error messages</span>
                <span class="c1"># TODO - blocking is not used anywhere - inquire!</span>
                <span class="n">blocking</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s2">&quot;Blocking&quot;</span><span class="p">,</span> <span class="n">VALID_BLOCKING</span><span class="p">)</span>  <span class="c1"># noqa</span>
                <span class="c1"># get function to perform experiment</span>
                <span class="n">function_name</span> <span class="o">=</span> <span class="n">imaging_settings</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span>
                    <span class="s2">&quot;FunctionName&quot;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="n">VALID_FUNCTIONNAME</span>
                <span class="p">)</span>
                <span class="n">function_to_use</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
                <span class="c1"># For segment wells, it is better to not display the dialog box</span>
                <span class="c1"># Reason - to make the workflow more seamless for the scientists</span>
                <span class="c1"># With this, they can leave after starting the 10X scan</span>
                <span class="c1"># and come back after segmentation to approve positions.</span>
                <span class="c1"># Instead of coming after the 10x scan to press ok for segment wells</span>
                <span class="k">if</span> <span class="n">function_name</span> <span class="o">!=</span> <span class="s2">&quot;segment_wells&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">less_dialog</span><span class="p">:</span>
                        <span class="c1"># if less dialog option enabled, fake user press</span>
                        <span class="c1"># and continue (return code 1)</span>
                        <span class="n">return_code</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">return_code</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">information_message</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">]),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">return_code</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>

                <span class="c1"># If return_code is 0, user pressed cancel</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">return_code</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save_state_and_exit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">control_autofocus</span><span class="p">(</span><span class="n">plate_object</span><span class="p">,</span> <span class="n">imaging_settings</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">hardware_status_dict</span> <span class="o">=</span> <span class="n">microscope_object</span><span class="o">.</span><span class="n">objective_ready_dict</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Repetitions&quot;</span><span class="p">]):</span>
                    <span class="c1"># execute experiment for each repetition</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">function_to_use</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;repetition&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">function_to_use</span><span class="p">(</span>
                                <span class="n">imaging_settings</span><span class="p">,</span>
                                <span class="n">plate_holder_object</span><span class="p">,</span>
                                <span class="n">experiment</span><span class="p">,</span>
                                <span class="n">repetition</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                <span class="n">wait_after_image</span><span class="o">=</span><span class="n">wait_after_image</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">function_to_use</span><span class="p">(</span>
                                <span class="n">imaging_settings</span><span class="p">,</span> <span class="n">plate_holder_object</span><span class="p">,</span> <span class="n">experiment</span>
                            <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">workflow_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment</span><span class="p">[</span><span class="s2">&quot;Experiment&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">StopCollectingError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">error_dialog</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="c1"># Wait for user interaction before continuing</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Repetition&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Repetition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">wait_message</span><span class="p">(</span>
                            <span class="s2">&quot;New repetition: do you want to &quot;</span>
                            <span class="s2">&quot;stop after the next image?&quot;</span>
                        <span class="p">)</span>
                        <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wait_after_image</span><span class="p">[</span><span class="s2">&quot;Repetition&quot;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished with plate scan&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../microscope_automation.html#microscope_automation.microscope_automation.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Regularized argument parsing</span>
    <span class="n">arg_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">arg_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--preferences&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to the preferences file&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">arg_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c1"># Check if argument is given and is a valid path.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">preferences</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">preferences</span><span class="p">):</span>
        <span class="n">prefs_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">preferences</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use UI file selector to prompt user for preferences file</span>
        <span class="n">fSelect</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="n">fSelect</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
        <span class="n">prefs_path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Select Preferences File to Use&quot;</span><span class="p">)</span>

    <span class="c1"># initialize the pyqt application object here (not in the location picker module)</span>
    <span class="c1"># as it only needs to be initialized once</span>
    <span class="k">global</span> <span class="n">app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mic</span> <span class="o">=</span> <span class="n">MicroscopeAutomation</span><span class="p">(</span><span class="n">prefs_path</span><span class="p">)</span>
        <span class="n">mic</span><span class="o">.</span><span class="n">microscope_automation</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">pyqtgraph</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="c1"># mic.state.save_state_and_exit()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
    <span class="c1"># Properly close pyqtgraph to avoid exit crash</span>
    <span class="n">pyqtgraph</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Microscope Automation</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware_components.html">hardware_components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware_control.html">hardware_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RS232.html">RS232</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup_microscope.html">setup_microscope</a></li>
</ul>
<p class="caption"><span class="caption-text">Samples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../correct_background.html">correct_background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../draw_plate.html">draw_plate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../find_well_center.html">find_well_center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../find_cells.html">find_cells</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interactive_location_picker_pyqtgraph.html">interactive_location_picker_pyqtgraph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../positions_list.html">positions_list</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples.html">samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup_samples.html">setup_samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tile_images.html">tile_images</a></li>
</ul>
<p class="caption"><span class="caption-text">Zeiss Microscopes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connect_zen_blue.html">connect_zen_blue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect_zen_black.html">connect_zen_black</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware_control_zeiss.html">hardware_control_zeiss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../write_zen_tiles_experiment.html">write_zen_tiles_experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zen_experiment_info.html">zen_experiment_info</a></li>
</ul>
<p class="caption"><span class="caption-text">3i Microscopes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware_control_3i.html">hardware_control_3i</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connect_slidebook.html">connect_slidebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slidebook_experiment_info.html">slidebook_experiment_info</a></li>
</ul>
<p class="caption"><span class="caption-text">General Methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../automation_exceptions.html">automation_exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../automation_messages_form_layout.html">automation_messages_form_layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../error_handling.html">error_handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get_path.html">get_path</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../image_AICS.html">image_AICS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../load_image_czi.html">load_image_czi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data_file.html">meta_data_file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../microscope_automation.html">microscope_automation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preferences.html">preferences</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Allen Institute Contribution Agreement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">LICENSE</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../microscope_automation.html">microscope_automation</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Allen Institute.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>